<template>
    <template if:true={isLoading}>
        <div class="spinner-container">
            <lightning-spinner alternative-text="Loading..." size="medium"></lightning-spinner>
        </div>
    </template>

    <!-- Error Message Display -->
    <template if:true={hasError}>
        <div class="wrapper">
            <div class="no-prop">
                <div class="empty-state">
                    <div class="empty-state__content">
                        <div class="empty-state__icon">
                            <img src="/resource/wfrecon__emptyState" alt="" draggable="false">
                        </div>
                        <div class="empty-state__message">Access Denied</div>
                        <div class="empty-state__subtitle">{errorMessage}</div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <div class="wrapper" if:false={hasError}>
        <!-- Accordion Sections -->
        <div class="accordion-container">
            <lightning-accordion active-section-name={activeSectionName} allow-multiple-sections-open="true" onsectiontoggle={handleSectionToggle}>
                <lightning-accordion-section name="jobDetails" label="Assigned Job Details">
                    <div class="job-details">
                        <!-- Tab Navigation -->
                        <div class="tab-navigation">
                            <button class={todayTabClass} onclick={handleTodayTab} data-tab="today">
                                Today's Job
                            </button>
                            <button class={weekTabClass} onclick={handleWeekTab} data-tab="week">
                                Weekly Jobs
                            </button>
                        </div>
    
                        <!-- Tab Content -->
                        <div class="tab-content">
                            <template if:true={isTodayTabActive}>
                                <div class="tab-panel">
                                    <template if:true={isTodayJobAvailable}>
                                        <div class="job-card">
                                            <template for:each={todayJobList} for:item="job" for:index="index">
                                                <div key={job.mobId} class="job-entry">
                                                    <!-- Left Side -->
                                                    <div class="job-left">
                                                        <div class="job-header">
                                                            <a class="record-link" href="javascript:void(0);" onclick={handleLinkClick} data-link={job.jobId}>
                                                                <h3 class="job-title">{job.jobName} ({job.jobNumber})</h3>
                                                            </a>
                                                            <div class="job-actions-inline">
                                                                <template if:true={job.isClockedIn}>
                                                                    <button class="clock-in-button" data-id={job.mobId} onclick={handleClockOut}>Clock Out</button>
                                                                </template>
                                                                <template if:false={job.isClockedIn}>
                                                                    <button class="clock-in-button" data-id={job.mobId} onclick={handleClockIn}>Clock In</button>
                                                                </template>
                                                            </div>
                                                        </div>
                                                        
                                                        <div class="job-description-text">
                                                            <span class="label">Description: </span> 
                                                            <span class={job.descriptionClass} data-full-text={job.jobDescription}>
                                                                {job.displayDescription}
                                                            </span>
                                                            <template if:true={job.showReadMore}>
                                                                <button class="read-more-btn" data-id={job.mobId} onclick={handleToggleDescription}>
                                                                    {job.readMoreText}
                                                                </button>
                                                            </template>
                                                        </div>

                                                        <div class="job-time">
                                                            <p class="job-start-time">
                                                                <span class="label">Start:</span> {job.jobStartTime} 
                                                            </p>
                                                            <p class="job-end-time">
                                                                <span class="label">End:</span> {job.jobEndTime}
                                                            </p>
                                                        </div>

                                                        <p><span class="label">Location:</span> {job.jobAddress}</p>

                                                        <template if:true={job.isAgain}>
                                                            <div class="info-message info-style">
                                                                You already logged one entry for the day.
                                                            </div>
                                                        </template>
                                                    </div>

                                                    <div class="separator"></div>
                                                        
                                                    <!-- Right Side -->
                                                    <div class="job-right">
                                                        <p class="location-title">Location</p>
                                                        <lightning-map map-markers={job.mapMarkers} zoom-level="15" class="map-container"></lightning-map>
                                                        <button class="clock-in-button" data-id={job.mobId} onclick={handleOpenInMaps}>Open in Maps</button>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </template>
                                    <div class="no-jobs-message" if:false={isTodayJobAvailable}>
                                        No jobs assigned for today
                                    </div>
                                </div>
                            </template>
    
                            <template if:true={isWeekTabActive}>
                                <div class="tab-panel">
                                    <div class="week-accordian-container">
                                        <lightning-accordion allow-multiple-sections-open>
                                            <template for:each={weekJobList} for:item="daySection">
                                                <lightning-accordion-section key={daySection.id} label={daySection.label}>
                                                    <template if:true={daySection.jobs.length}>
                                                        <div class="weekly-job-cards">
                                                            <div class="job-card">
                                                                <template for:each={daySection.jobs} for:item="job">
                                                                    <div key={job.mobId} class="job-entry">
                                                                        <!-- Left Side -->
                                                                        <div class="job-left">
                                                                            <a class="record-link" href="javascript:void(0);" onclick={handleLinkClick} data-link={job.jobId}>
                                                                                <h3 class="job-title">{job.jobName} ({job.jobNumber})</h3>
                                                                            </a>
                                                                            <div class="job-description-text">
                                                                                <span class="label">Description:</span> 
                                                                                <span class={job.descriptionClass} data-full-text={job.jobDescription}>
                                                                                    {job.displayDescription}
                                                                                </span>
                                                                                <template if:true={job.showReadMore}>
                                                                                    <button class="read-more-btn" data-id={job.mobId} onclick={handleToggleDescription}>
                                                                                        {job.readMoreText}
                                                                                    </button>
                                                                                </template>
                                                                            </div>
        
                                                                            <div class="job-time">
                                                                                <p class="job-start-time">
                                                                                    <span class="label">Start:</span> {job.jobStartTime} 
                                                                                </p>
                                                                                <p class="job-end-time">
                                                                                    <span class="label">End:</span> {job.jobEndTime}
                                                                                </p>
                                                                            </div>
        
                                                                            <p><span class="label">Location:</span> {job.jobAddress}</p>
                                                                        </div>
        
                                                                        <div class="separator"></div>
        
                                                                        <!-- Right Side -->
                                                                        <div class="job-right">
                                                                            <p class="location-title">Location</p>
                                                                            <lightning-map map-markers={job.mapMarkers} zoom-level="15" class="map-container"></lightning-map>
                                                                            <button class="clock-in-button" data-id={job.mobId} onclick={handleOpenInMaps}>Open in Maps</button>
                                                                        </div>
                                                                    </div>
                                                                </template>
                                                            </div>
                                                        </div>
                                                    </template>
                                                    <template if:false={daySection.jobs.length}>
                                                        <p class="no-jobs">No jobs assigned for this day.</p>
                                                    </template>
                                                </lightning-accordion-section>
                                            </template>
                                        </lightning-accordion>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </lightning-accordion-section>
                <lightning-accordion-section name="timesheetDetails" label="Current Week's Timesheet Details">
                    <div class="timesheet-details">
                        <template if:true={timesheetDetailsRaw.length}>
                            <div class="summary-cards-container">
                                <div class="summary-card">
                                    <div class="summary-card-title">
                                        Total Travel Time
                                    </div>
                                    <div class="summary-card-value">
                                        <lightning-formatted-number value={currentWeekTravelTime} format-style="decimal" maximum-fraction-digits="2"></lightning-formatted-number>
                                    </div>
                                    <div class="summary-card-subtitle"></div>
                                </div>
                                <div class="summary-card">
                                    <div class="summary-card-title">
                                        Total Work Hours
                                    </div>
                                    <div class="summary-card-value">
                                        <lightning-formatted-number value={currentTotalWorkHours} format-style="decimal" maximum-fraction-digits="2"></lightning-formatted-number>
                                    </div>
                                    <div class="summary-card-subtitle"></div>
                                </div>
                            </div>
                            <div class="table-content timesheet-table">
                                <table class="slds-table">
                                    <thead>
                                        <tr>
                                            <template for:each={timesheetColumns} for:item="col">
                                                <th key={col.fieldName} scope="col" style={col.style}>
                                                    <div class="slds-truncate" title={col.label}>{col.label}</div>
                                                </th>
                                            </template>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <template for:each={timesheetDetails} for:item="timesheet" for:index="index">
                                            <tr key={timesheet.id}>
                                                <template for:each={timesheet.values} for:item="val">
                                                    <td key={val} style={val.style}>
                                                        <div class="slds-truncate cell-wrapper" title={val.value}>
                                                            <template if:true={val.isActions}>
                                                                <div class="action-button-container">
                                                                    <div class="timesheet-icon">
                                                                        <lightning-button-icon icon-name="utility:edit" alternative-text="Edit Action" variant="bare" data-id={timesheet.id} onclick={handleEditTimesheetClick}></lightning-button-icon>
                                                                    </div>
                                                                </div>
                                                            </template>

                                                            <template if:false={val.isActions}>
                                                                <template if:true={val.recordLink}>
                                                                    <a class="record-link" href="javascript:void(0);" onclick={handleLinkClick} data-link={timesheet.jobId}>
                                                                        <div class="cell-content" title={val.value}>
                                                                            {val.value}
                                                                        </div>
                                                                    </a>
                                                                </template>
                                                                <template if:false={val.recordLink}>
                                                                    <div class="cell-content" title={val.value}>
                                                                        {val.value}
                                                                    </div>
                                                                </template>
                                                            </template>
                                                        </div>
                                                    </td>
                                                </template>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </template>
                        <template if:false={timesheetDetailsRaw.length}>
                            <div class="no-records-message">
                                <div class="empty-state">
                                    <div class="empty-state__content">
                                        <div class="empty-state__icon">
                                            <img src="/resource/wfrecon__emptyState" alt="" draggable="false">
                                        </div>
                                        <div class="empty-state__message">No timesheet data available for past week</div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </lightning-accordion-section>
            </lightning-accordion>
        </div>

        <template if:true={showClockInModal}>
            <section role="dialog" tabindex="-1" aria-labelledby="modal-heading-01" aria-modal="true" aria-describedby="modal-content-id-1" class="slds-modal slds-fade-in-open">
                <div class="slds-modal__container">
                    <!-- Close Button -->
                    <button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse" title="Close" onclick={closeClockInModal}>
                        <lightning-icon icon-name="utility:close" alternative-text="Close" class="close-icon" size="small"></lightning-icon>
                    </button>

                    <!-- Heading -->
                    <div class="pop-heading">
                        Clock In Time
                    </div>

                    <!-- Body -->
                    <div class="slds-modal__content pop-up" id="modal-content-id-2">
                        <div class="popUpBody">
                            <div class="clock-in-container">
                                <div class="input-column">
                                    <div class="datetime-container">
                                        <label class="datetime-label">Job Start Date</label>
                                        <div class="datetime-wrapper">
                                            <input type="text" class="custom-datetime input-disabled" value={modalJobStartTime} disabled />
                                        </div>
                                    </div>
                                </div>
                                <div class="input-column">
                                    <div class="datetime-container">
                                        <label class="datetime-label">Job End Date</label>
                                        <div class="datetime-wrapper">
                                            <input type="text" class="custom-datetime input-disabled" value={modalJobEndTime} disabled />
                                        </div>
                                    </div>
                                </div>
                                <div class="input-column">
                                    <div class="select-person-container">
                                        <label class="select-label required">Select Cost Code</label>
                                        <div class="select-wrapper">
                                            <select class="custom-select-costcode" data-field="costCode" onchange={handleInputChange}>
                                                <option value="">-- Select a cost code --</option>
                                                <template for:each={costCodeOptions} for:item="option">
                                                    <option key={option.value} value={option.value}>{option.label}</option>
                                                </template>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="input-column">
                                    <div class="datetime-container">
                                        <label class="datetime-label required">Clock In DateTime</label>
                                        <div class="datetime-wrapper">
                                            <input type="datetime-local" class="custom-datetime" data-field="clockIn" value={clockInTime} onchange={handleInputChange} min={clockInMinBoundary} max={clockInMaxBoundary} />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="popUpFooter">
                        <button class="clock-in-button" onclick={saveClockIn}>Clock In</button>
                    </div>
                </div>
            </section>
            <div class="slds-backdrop slds-backdrop_open"></div>
        </template>

        <template if:true={showClockOutModal}>
            <section role="dialog" tabindex="-1" aria-labelledby="modal-heading-01" aria-modal="true" aria-describedby="modal-content-id-1" class="slds-modal slds-fade-in-open">
                <div class="slds-modal__container">
                    <!-- Close Button -->
                    <button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse" title="Close" onclick={closeClockOutModal}>
                        <lightning-icon icon-name="utility:close" alternative-text="Close" class="close-icon" size="small"></lightning-icon>
                    </button>

                    <!-- Heading -->
                    <div class="pop-heading">
                        Clock Out Time
                    </div>

                    <!-- Body -->
                    <div class="slds-modal__content pop-up" id="modal-content-id">
                        <div class="popUpBody">
                            <div class="clock-in-container">
                                <div class="input-column">
                                    <div class="datetime-container">
                                        <label class="datetime-label">Job Start Date</label>
                                        <div class="datetime-wrapper">
                                            <input type="text" class="custom-datetime input-disabled" value={modalJobStartTime} disabled />
                                        </div>
                                    </div>
                                </div>
                                <div class="input-column">
                                    <div class="datetime-container">
                                        <label class="datetime-label">Job End Date</label>
                                        <div class="datetime-wrapper">
                                            <input type="text" class="custom-datetime input-disabled" value={modalJobEndTime} disabled />
                                        </div>
                                    </div>
                                </div>
                                <template if:true={previousClockInTime}>
                                    <div class="input-column">
                                        <div class="datetime-container">
                                            <label class="datetime-label">Clock In DateTime</label>
                                            <div class="datetime-wrapper">
                                                <input type="text" class="custom-datetime input-disabled" value={previousClockInTime} disabled />
                                            </div>
                                        </div>
                                    </div>
                                </template>
                                <div class="form-wrapper">
                                    <div class="input-column">
                                        <div class="datetime-container">
                                            <label class="datetime-label required">Clock Out DateTime</label>
                                            <div class="datetime-wrapper">
                                                <input type="datetime-local" class="custom-datetime" data-field="clockOut" value={clockOutTime} onchange={handleInputChange} min={clockOutMinBoundary} max={clockOutMaxBoundary} />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="popUpFooter">
                        <button class="clock-in-button" onclick={saveClockOut}>Clock Out</button>
                    </div>
                </div>
            </section>
            <div class="slds-backdrop slds-backdrop_open"></div>
        </template>
    </div>
</template>