<template>
    <template if:true={isLoading}>
        <div class="spinner-container">
            <lightning-spinner alternative-text="Loading..." size="medium"></lightning-spinner>
        </div>
    </template>

    <!-- Error Message Display -->
    <template if:true={hasError}>
        <div class="wrapper">
            <div class="no-prop">
                <div class="empty-state">
                    <div class="empty-state__content">
                        <div class="empty-state__icon">
                            <img src="/resource/wfrecon__emptyState" alt="" draggable="false">
                        </div>
                        <!-- <div class="empty-state__message">Access Denied</div> -->
                        <div class="empty-state__subtitle">{errorMessage}</div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <div class="wrapper" if:false={hasError}>
        <!-- Accordion Sections -->
        <div class="accordion-container">
            <lightning-accordion active-section-name={activeSectionName} allow-multiple-sections-open="true" onsectiontoggle={handleSectionToggle}>
                <lightning-accordion-section name="jobDetails" label="Assigned Job Details">
                    <div class="job-details">
                        <!-- Tab Navigation -->
                        <div class="tab-navigation">
                            <button class={todayTabClass} onclick={handleTodayTab} data-tab="today">
                                Today's Job
                            </button>
                            <button class={weekTabClass} onclick={handleWeekTab} data-tab="week">
                                Weekly Jobs
                            </button>
                        </div>
    
                        <!-- Tab Content -->
                        <div class="tab-content">
                            <template if:true={isTodayTabActive}>
                                <div class="tab-panel">
                                    <template if:true={isTodayJobAvailable}>
                                        <div class="cards-list-container">
                                            <template for:each={todayJobList} for:item="job">
                                                <div key={job.mobId} class="custom-job-card">
                                                    <div class="card-header">
                                                        <div class="header-info">
                                                            <a class="record-link" href="javascript:void(0);" onclick={handleLinkClick} data-link={job.jobId}>
                                                                <h3 class="job-title">{job.jobName}</h3>
                                                                <span class="job-number">#{job.jobNumber}</span>
                                                            </a>
                                                        </div>
                                                        <div class="header-actions">
                                                            <button class="action-btn map-btn" data-id={job.mobId} onclick={handleOpenInMaps} title="Open in Maps">
                                                                <lightning-icon icon-name="utility:checkin" size="x-small" class="btn-icon"></lightning-icon>
                                                            </button>
                                                            
                                                            <template if:true={job.isCrewLeader}>
                                                                <button class="action-btn clock-in-btn" data-id={job.mobId} onclick={handleCrewClockInOut}>Crew Clock In/out</button>
                                                            </template>

                                                            <template if:false={job.isCrewLeader}>
                                                                <template if:true={job.isClockedIn}>
                                                                    <button class="action-btn clock-out-btn" data-id={job.mobId} onclick={handleClockOut}>Clock Out</button>
                                                                </template>
                                                                <template if:false={job.isClockedIn}>
                                                                    <template if:true={job.isAgain}>
                                                                        <button class="action-btn clock-in-btn" data-id={job.mobId} onclick={handleClockIn}>Clock In Again</button>
                                                                    </template>
                                                                    <template if:false={job.isAgain}>
                                                                        <button class="action-btn clock-in-btn" data-id={job.mobId} onclick={handleClockIn}>Clock In</button>
                                                                    </template>
                                                                </template>
                                                            </template>
                                                            </div>
                                                    </div>
                                                    
                                                    <div class="card-body">
                                                        <div class="description-section">
                                                            <span class="label">Description:</span> 
                                                            <span class={job.descriptionClass} data-full-text={job.jobDescription}>
                                                                {job.displayDescription}
                                                            </span>
                                                            <template if:true={job.showReadMore}>
                                                                <button class="read-more-link" data-id={job.mobId} onclick={handleToggleDescription}>
                                                                    {job.readMoreText}
                                                                </button>
                                                            </template>
                                                        </div>

                                                        <div class="info-grid">
                                                            <div class="info-item">
                                                                <span class="label">Job Start Date:</span>
                                                                <span class="value">{job.jobStartTime}</span>
                                                            </div>
                                                            <div class="info-item">
                                                                <span class="label">Job End Date:</span>
                                                                <span class="value">{job.jobEndTime}</span>
                                                            </div>
                                                        </div>

                                                        <div class="location-section">
                                                            <lightning-icon icon-name="utility:location" size="xx-small" class="loc-icon"></lightning-icon>
                                                            <span class="value">{job.jobAddress}</span>
                                                        </div>

                                                        <template if:true={job.isAgain}>
                                                            <template if:true={job.hasLastEntry}>
                                                                <div class="recent-session">
                                                                    <div class="session-label">Previous Session</div>
                                                                    <div class="session-times">
                                                                        <span class="session-in">In: {job.lastClockInFormatted}</span>
                                                                        <span class="session-separator">â†’</span>
                                                                        <span class="session-out">Out: {job.lastClockOutFormatted}</span>
                                                                    </div>
                                                                </div>
                                                            </template>
                                                        </template>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </template>
                                    <div class="no-jobs-message" if:false={isTodayJobAvailable}>
                                        No jobs assigned for today
                                    </div>
                                </div>
                            </template>
    
                            <template if:true={isWeekTabActive}>
                                <div class="tab-panel">
                                    <div class="week-accordion-container">
                                        <lightning-accordion allow-multiple-sections-open>
                                            <template for:each={weekJobList} for:item="daySection">
                                                <lightning-accordion-section key={daySection.id} label={daySection.label}>
                                                    <template if:true={daySection.jobs.length}>
                                                        <div class="cards-list-container">
                                                            <template for:each={daySection.jobs} for:item="job">
                                                                <div key={job.mobId} class="custom-job-card">
                                                                    <div class="card-header">
                                                                        <div class="header-info">
                                                                            <a class="record-link" href="javascript:void(0);" onclick={handleLinkClick} data-link={job.jobId}>
                                                                                <h3 class="job-title">{job.jobName}</h3>
                                                                                <span class="job-number">#{job.jobNumber}</span>
                                                                            </a>
                                                                        </div>
                                                                        <div class="header-actions">
                                                                            <button class="action-btn map-btn" data-id={job.mobId} onclick={handleOpenInMaps} title="Open in Maps">
                                                                                <lightning-icon icon-name="utility:checkin" size="x-small" class="btn-icon"></lightning-icon>
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                    
                                                                    <div class="card-body">
                                                                        <div class="description-section">
                                                                            <span class="label">Description:</span> 
                                                                            <span class={job.descriptionClass} data-full-text={job.jobDescription}>
                                                                                {job.displayDescription}
                                                                            </span>
                                                                            <template if:true={job.showReadMore}>
                                                                                <button class="read-more-link" data-id={job.mobId} onclick={handleToggleDescription}>
                                                                                    {job.readMoreText}
                                                                                </button>
                                                                            </template>
                                                                        </div>

                                                                        <div class="info-grid">
                                                                            <div class="info-item">
                                                                                <span class="label">Job Start Date:</span>
                                                                                <span class="value">{job.jobStartTime}</span>
                                                                            </div>
                                                                            <div class="info-item">
                                                                                <span class="label">Job End Date:</span>
                                                                                <span class="value">{job.jobEndTime}</span>
                                                                            </div>
                                                                        </div>
                
                                                                        <div class="location-section">
                                                                            <lightning-icon icon-name="utility:location" size="xx-small" class="loc-icon"></lightning-icon>
                                                                            <span class="value">{job.jobAddress}</span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </template>
                                                        </div>
                                                    </template>
                                                    <template if:false={daySection.jobs.length}>
                                                        <p class="no-jobs">No jobs assigned for this day.</p>
                                                    </template>
                                                </lightning-accordion-section>
                                            </template>
                                        </lightning-accordion>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </lightning-accordion-section>
                
                <lightning-accordion-section name="timesheetDetails" label="Current Week's Timesheet Details">
                    <div class="timesheet-details">
                        <template if:true={timesheetDetailsRaw.length}>
                            <div class="summary-cards-container">
                                <div class="summary-card">
                                    <div class="summary-card-title">
                                        Total Work Hours
                                    </div>
                                    <div class="summary-card-value">
                                        <lightning-formatted-number value={currentTotalWorkHours} format-style="decimal" maximum-fraction-digits="2"></lightning-formatted-number>
                                    </div>
                                    <div class="summary-card-subtitle"></div>
                                </div>
                                <div class="summary-card">
                                    <div class="summary-card-title">
                                        Total Travel Hours
                                    </div>
                                    <div class="summary-card-value">
                                        <lightning-formatted-number value={currentWeekTravelTime} format-style="decimal" maximum-fraction-digits="2"></lightning-formatted-number>
                                    </div>
                                    <div class="summary-card-subtitle"></div>
                                </div>
                            </div>
                            
                            <template if:false={isMobileDevice}>
                                <div class="table-content timesheet-table">
                                    <table class="slds-table">
                                        <thead>
                                            <tr>
                                                <template for:each={mainTableColumns} for:item="col">
                                                    <th key={col.fieldName} scope="col" style={col.style}>
                                                        <div class="slds-truncate" title={col.label}>{col.label}</div>
                                                    </th>
                                                </template>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <template for:each={groupedTimesheets} for:item="day">
                                                <tr key={day.id} class="main-row">
                                                    <td class="action-column">
                                                        <button 
                                                            class="icon-button child-records-btn" 
                                                            title="View Details" 
                                                            data-id={day.id} 
                                                            data-expanded={day.isExpanded}
                                                            onclick={handleToggleTimesheetRow}>
                                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                                <template if:true={day.isExpanded}>
                                                                    <path d="M18 15L12 9L6 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                                </template>
                                                                <template if:false={day.isExpanded}>
                                                                    <path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                                </template>
                                                            </svg>
                                                        </button>
                                                    </td>
                                                    <td><div class="slds-truncate" title={day.dateLabel}>{day.dateLabel}</div></td>
                                                    <td><div class="slds-truncate" title={day.jobNames}>{day.jobNames}</div></td>
                                                    <td><div class="slds-truncate" title={day.totalHours}>{day.totalHours}</div></td>
                                                    <td><div class="slds-truncate" title={day.totalTravelHours}>{day.totalTravelHours}</div></td>
                                                </tr>

                                                <template if:true={day.isExpanded}>
                                                    <tr key={day.id} class="nested-row">
                                                        <td colspan="5">
                                                            <div class="nested-table-container">
                                                                <div class="nested-table-wrapper">
                                                                    <div class="nested-table-header">
                                                                        <h4 class="nested-table-title">Timesheet Entry for {day.dateLabel}</h4>
                                                                    </div>
                                                                    <table class="nested-table">
                                                                        <thead>
                                                                            <tr>
                                                                                <template for:each={subTableColumns} for:item="subCol">
                                                                                    <th key={subCol.fieldName} style={subCol.style}>{subCol.label}</th>
                                                                                </template>
                                                                            </tr>
                                                                        </thead>
                                                                        <tbody>
                                                                            <template for:each={day.entries} for:item="entry">
                                                                                <tr key={entry.id} class="nested-table-row">
                                                                                    <td>{entry.jobName}</td>
                                                                                    <td>{entry.clockInTime}</td>
                                                                                    <td>{entry.clockOutTime}</td>
                                                                                    <td>{entry.workHours}</td>
                                                                                    <td>{entry.travelTime}</td>
                                                                                </tr>
                                                                            </template>
                                                                        </tbody>
                                                                    </table>
                                                                </div>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                </template>
                                            </template>
                                        </tbody>
                                    </table>
                                </div>
                            </template>

                            <template if:true={isMobileDevice}>
                                <div class="mobile-timesheet-container">
                                    <lightning-accordion allow-multiple-sections-open>
                                        <template for:each={dailyTimesheetSummary} for:item="day">
                                            <lightning-accordion-section key={day.date} label={day.label} class="mobile-timesheet-section">
                                                
                                                <div class="ts-entries-list">
                                                    <template for:each={day.entries} for:item="entry">
                                                        <div key={entry.id} class="summary-card">
                                                            <div class="ts-card-header">
                                                                <div class="ts-job-name">{entry.jobName}</div>
                                                                <div class="ts-job-num">#{entry.jobNumber}</div>
                                                            </div>
                                                            <div class="ts-card-body">
                                                                <div class="ts-stat">
                                                                    <span class="ts-label">Work</span>
                                                                    <span class="ts-val">{entry.workHours}</span>
                                                                </div>
                                                                <div class="ts-stat">
                                                                    <span class="ts-label">Travel</span>
                                                                    <span class="ts-val">{entry.travelTime}</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </template>
                                                </div>

                                            </lightning-accordion-section>
                                        </template>
                                    </lightning-accordion>
                                </div>
                            </template>

                        </template>

                        <template if:false={timesheetDetailsRaw.length}>
                            <div class="no-records-message">
                                <div class="empty-state">
                                    <div class="empty-state__content">
                                        <div class="empty-state__icon">
                                            <img src="/resource/wfrecon__emptyState" alt="" draggable="false">
                                        </div>
                                        <div class="empty-state__message">No timesheet data available for past week</div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </lightning-accordion-section>
            </lightning-accordion>
        </div>

        <template if:true={showClockInModal}>
            <section role="dialog" tabindex="-1" aria-labelledby="modal-heading-01" aria-modal="true" aria-describedby="modal-content-id-1" class="slds-modal slds-fade-in-open">
                <div class="slds-modal__container">
                    <!-- Close Button -->
                    <button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse" title="Close" onclick={closeClockInModal}>
                        <lightning-icon icon-name="utility:close" alternative-text="Close" class="close-icon" size="small"></lightning-icon>
                    </button>

                    <!-- Heading -->
                    <div class="pop-heading">
                        Clock In Time
                    </div>

                    <!-- Body -->
                    <div class="slds-modal__content pop-up" id="modal-content-id-2">
                        <div class="popUpBody">
                            <div class="clock-in-container">
                                <div class="input-column">
                                    <div class="datetime-container">
                                        <label class="datetime-label">Job Start Time</label>
                                        <div class="datetime-wrapper">
                                            <input type="text" class="custom-datetime input-disabled" value={modalJobStartTime} disabled />
                                        </div>
                                    </div>
                                </div>
                                <div class="input-column">
                                    <div class="datetime-container">
                                        <label class="datetime-label">Job End Time</label>
                                        <div class="datetime-wrapper">
                                            <input type="text" class="custom-datetime input-disabled" value={modalJobEndTime} disabled />
                                        </div>
                                    </div>
                                </div>
                                <div class="input-column">
                                    <div class="select-person-container">
                                        <label class="select-label required">Select Cost Code</label>
                                        <div class="select-wrapper">
                                            <select class="custom-select-costcode" data-field="costCode" onchange={handleInputChange}>
                                                <option value="">-- Select a cost code --</option>
                                                <template for:each={costCodeOptions} for:item="option">
                                                    <option key={option.value} value={option.value}>{option.label}</option>
                                                </template>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="input-column">
                                    <div class="datetime-container">
                                        <label class="datetime-label">Clock In Time</label>
                                        <div class="datetime-wrapper">
                                            <input type="text" class="custom-datetime input-disabled" value={currentDisplayTime} disabled />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="popUpFooter">
                        <button class="clock-in-button" onclick={saveClockIn}>Clock In</button>
                    </div>
                </div>
            </section>
            <div class="slds-backdrop slds-backdrop_open"></div>
        </template>

        <template if:true={showClockOutModal}>
            <section role="dialog" tabindex="-1" aria-labelledby="modal-heading-01" aria-modal="true" aria-describedby="modal-content-id-1" class="slds-modal slds-fade-in-open">
                <div class="slds-modal__container">
                    <!-- Close Button -->
                    <button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse" title="Close" onclick={closeClockOutModal}>
                        <lightning-icon icon-name="utility:close" alternative-text="Close" class="close-icon" size="small"></lightning-icon>
                    </button>

                    <!-- Heading -->
                    <div class="pop-heading">
                        Clock Out Time
                    </div>

                    <!-- Body -->
                    <div class="slds-modal__content pop-up" id="modal-content-id">
                        <div class="popUpBody">
                            <div class="clock-in-container">
                                <div class="input-column">
                                    <div class="datetime-container">
                                        <label class="datetime-label">Job Start Time</label>
                                        <div class="datetime-wrapper">
                                            <input type="text" class="custom-datetime input-disabled" value={modalJobStartTime} disabled />
                                        </div>
                                    </div>
                                </div>
                                <div class="input-column">
                                    <div class="datetime-container">
                                        <label class="datetime-label">Job End Time</label>
                                        <div class="datetime-wrapper">
                                            <input type="text" class="custom-datetime input-disabled" value={modalJobEndTime} disabled />
                                        </div>
                                    </div>
                                </div>
                                <template if:true={previousClockInTime}>
                                    <div class="input-column">
                                        <div class="datetime-container">
                                            <label class="datetime-label">Previous Clock In Time</label>
                                            <div class="datetime-wrapper">
                                                <input type="text" class="custom-datetime input-disabled" value={previousClockInTime} disabled />
                                            </div>
                                        </div>
                                    </div>
                                </template>
                                <div class="form-wrapper">
                                    <div class="input-column">
                                        <div class="datetime-container">
                                            <label class="datetime-label">Clock Out Time</label>
                                            <div class="datetime-wrapper">
                                                <input type="text" class="custom-datetime input-disabled" value={currentDisplayTime} disabled />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="popUpFooter">
                        <button class="clock-in-button" onclick={saveClockOut}>Clock Out</button>
                    </div>
                </div>
            </section>
            <div class="slds-backdrop slds-backdrop_open"></div>
        </template>

        <template if:true={showCrewModal}>
            <c-whole-crew-clock-in-out 
                record-id={selectedJobId} 
                is-home-page="true" 
                onclosepopup={closeCrewModal}>
            </c-whole-crew-clock-in-out>
        </template>
    </div>
</template>