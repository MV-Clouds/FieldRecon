<template>
    <div class="dashboard-container">
        <!-- Filters Section -->
        <div class="filters-section">
            <div class="filter-row">
                <!-- Date Filter -->
                <div class="filter-item">
                    <label class="filter-label">Date Range</label>
                    <select class="custom-select" onchange={handleDateFilterChange}>
                        <template for:each={dateFilterOptions} for:item="option">
                            <option key={option.value} value={option.value} selected={option.selected}>{option.label}</option>
                        </template>
                    </select>
                </div>

                <!-- Status Filter -->
                <div class="filter-item">
                    <label class="filter-label">Status</label>
                    <select class="custom-select" onchange={handleStatusFilterChange}>
                        <template for:each={statusFilterOptions} for:item="option">
                            <option key={option.value} value={option.value} selected={option.selected}>{option.label}</option>
                        </template>
                    </select>
                </div>

                <!-- Search -->
                <div class="filter-item search-item">
                    <label class="filter-label">Search</label>
                    <div class="search-wrapper">
                        <svg class="search-icon" viewBox="0 0 24 24">
                            <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                        </svg>
                        <input 
                            type="text" 
                            class="search-input" 
                            placeholder="Search logs..." 
                            onkeyup={handleSearch}
                        />
                    </div>
                </div>
            </div>
        </div>

        <!-- KPI Cards -->
        <div class="kpi-section">
            <div class="kpi-card kpi-total">
                <div class="kpi-icon-wrapper">
                    <svg class="kpi-icon" viewBox="0 0 24 24">
                        <path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                    </svg>
                </div>
                <div class="kpi-content">
                    <div class="kpi-value">{totalLogs}</div>
                    <div class="kpi-label">Total Logs</div>
                </div>
            </div>

            <div class="kpi-card kpi-pending">
                <div class="kpi-icon-wrapper">
                    <svg class="kpi-icon" viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                </div>
                <div class="kpi-content">
                    <div class="kpi-value">{pendingLogs}</div>
                    <div class="kpi-label">Pending</div>
                </div>
            </div>

            <div class="kpi-card kpi-approved">
                <div class="kpi-icon-wrapper">
                    <svg class="kpi-icon" viewBox="0 0 24 24">
                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                    </svg>
                </div>
                <div class="kpi-content">
                    <div class="kpi-value">{approvedLogs}</div>
                    <div class="kpi-label">Approved</div>
                </div>
            </div>

            <div class="kpi-card kpi-auto-approved">
                <div class="kpi-icon-wrapper">
                    <svg class="kpi-icon" viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                    </svg>
                </div>
                <div class="kpi-content">
                    <div class="kpi-value">{autoApprovedLogs}</div>
                    <div class="kpi-label">Auto-Approved</div>
                </div>
            </div>

            <div class="kpi-card kpi-rejected">
                <div class="kpi-icon-wrapper">
                    <svg class="kpi-icon" viewBox="0 0 24 24">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                    </svg>
                </div>
                <div class="kpi-content">
                    <div class="kpi-value">{rejectedLogs}</div>
                    <div class="kpi-label">Rejected</div>
                </div>
            </div>
        </div>

        <!-- Loading Spinner -->
        <template if:true={isLoading}>
            <div class="spinner-overlay">
                <div class="spinner"></div>
            </div>
        </template>

        <!-- Data Table -->
        <template if:true={hasLogs}>
            <div class="table-container">
                <table class="custom-table">
                    <thead>
                        <tr>
                            <th class="th-log-number">Log Number</th>
                            <th class="th-job">Job</th>
                            <th class="th-text">Work Performed</th>
                            <th class="th-text">Plan for Tomorrow</th>
                            <th class="th-text">Exceptions</th>
                            <th class="th-text">Notes to Office</th>
                            <th class="th-created">Created Date</th>
                            <th class="th-created-by">Created By</th>
                            <th class="th-status">Status</th>
                            <th class="th-actions">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template for:each={filteredLogEntries} for:item="log">
                            <tr key={log.id} class="table-row">
                                <td class="td-log-number">{log.name}</td>
                                <td class="td-job">
                                    <template if:true={log.jobId}>
                                        <a 
                                            href="#" 
                                            class="job-link" 
                                            data-job-id={log.jobId}
                                            onclick={handleJobClick}
                                        >
                                            <div class="job-info">
                                                <div class="job-name">{log.jobName}</div>
                                                <div class="job-number">{log.jobNumber}</div>
                                            </div>
                                        </a>
                                    </template>
                                    <template if:false={log.jobId}>
                                        <span class="no-data">--</span>
                                    </template>
                                </td>
                                <td class="td-text">
                                    <div class="text-content">{log.workPerformed}</div>
                                </td>
                                <td class="td-text">
                                    <div class="text-content">{log.planForTomorrow}</div>
                                </td>
                                <td class="td-text">
                                    <div class="text-content">{log.exceptions}</div>
                                </td>
                                <td class="td-text">
                                    <div class="text-content">{log.notesToOffice}</div>
                                </td>
                                <td class="td-created">{log.createdDate}</td>
                                <td class="td-created-by">{log.createdBy}</td>
                                <td class="td-status">
                                    <span class={log.statusClass}>{log.status}</span>
                                </td>
                                <td class="td-actions">
                                    <div class="action-buttons">
                                        <!-- Files Button -->
                                        <button 
                                            class="action-btn btn-files" 
                                            data-log-id={log.id}
                                            onclick={handleShowFiles}
                                            title="View Files"
                                        >
                                            <svg class="btn-icon" viewBox="0 0 24 24">
                                                <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zM6 20V4h7v5h5v11H6z"/>
                                            </svg>
                                        </button>
                                        
                                        <!-- Location Process Button -->
                                        <button 
                                            class="action-btn btn-location" 
                                            data-log-id={log.id}
                                            onclick={handleShowLocationProcesses}
                                            title="View Location Processes"
                                        >
                                            <svg class="btn-icon" viewBox="0 0 24 24">
                                                <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                                            </svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </template>

        <!-- Empty State -->
        <template if:false={hasLogs}>
            <div class="empty-state">
                <svg class="empty-icon" viewBox="0 0 24 24">
                    <path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                </svg>
                <h2 class="empty-title">No Shift End Logs Found</h2>
                <p class="empty-message">Try adjusting your filters or date range</p>
            </div>
        </template>

        <!-- File Viewer Modal -->
        <template if:true={showFileViewer}>
            <div class="modal-overlay" onclick={handleCloseFileViewer}>
                <div class="modal-container" onclick={handleStopPropagation}>
                    <div class="modal-header">
                        <h2 class="modal-title">Attached Files</h2>
                        <button class="modal-close-btn" onclick={handleCloseFileViewer}>
                            <svg class="close-icon" viewBox="0 0 24 24">
                                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                            </svg>
                        </button>
                    </div>
                    <div class="modal-body">
                        <template if:true={hasFiles}>
                            <div class="files-grid">
                                <template for:each={files} for:item="file">
                                    <div key={file.id} class="file-card">
                                        <div class="file-preview">
                                            <template if:true={file.isImage}>
                                                <img src={file.previewUrl} alt={file.title} class="file-image" />
                                            </template>
                                            <template if:false={file.isImage}>
                                                <div class="file-icon-wrapper">
                                                    <template if:true={file.isPdf}>
                                                        <svg class="file-icon pdf-icon" viewBox="0 0 24 24">
                                                            <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zM6 20V4h7v5h5v11H6z"/>
                                                        </svg>
                                                    </template>
                                                    <template if:false={file.isPdf}>
                                                        <svg class="file-icon doc-icon" viewBox="0 0 24 24">
                                                            <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zM6 20V4h7v5h5v11H6z"/>
                                                        </svg>
                                                    </template>
                                                </div>
                                            </template>
                                        </div>
                                        <div class="file-info">
                                            <div class="file-title" title={file.title}>{file.title}</div>
                                            <div class="file-meta">
                                                <span class="file-extension">{file.fileExtension}</span>
                                                <span class="file-size">{file.fileSize}</span>
                                            </div>
                                        </div>
                                        <button 
                                            class="file-download-btn" 
                                            data-url={file.downloadUrl}
                                            onclick={handleDownloadFile}
                                            title="Download"
                                        >
                                            <svg class="download-icon" viewBox="0 0 24 24">
                                                <path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2z"/>
                                            </svg>
                                        </button>
                                    </div>
                                </template>
                            </div>
                        </template>
                        <template if:false={hasFiles}>
                            <div class="empty-files">
                                <p>No files attached to this log entry</p>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </template>

        <!-- Location Process Slider -->
        <template if:true={showLocationProcessSlider}>
            <div class="slider-overlay">
                <div class="slider-container">
                    <div class="slider-header">
                        <h2 class="slider-title">Location Processes</h2>
                        <button class="slider-close-btn" onclick={handleCloseLocationProcessSlider}>
                            <svg class="close-icon" viewBox="0 0 24 24">
                                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                            </svg>
                        </button>
                    </div>
                    <div class="slider-body">
                        <template if:true={hasLocationProcesses}>
                            <template for:each={locationProcesses} for:item="lp">
                                <div key={lp.id} class="location-process-item">
                                    <div class="lp-header">
                                        <h3 class="lp-name">{lp.name}</h3>
                                        <div class="lp-values">
                                            <span class="lp-old-value">{lp.oldValue}%</span>
                                            <svg class="arrow-icon" viewBox="0 0 24 24">
                                                <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
                                            </svg>
                                            <span class="lp-new-value">{lp.newValue}%</span>
                                        </div>
                                    </div>
                                    <div class="progress-container">
                                        <div class="progress-bar-wrapper">
                                            <div class="progress-bar progress-old" style={lp.oldProgressStyle}>
                                                <div class="progress-fill-old"></div>
                                            </div>
                                            <div class="progress-bar progress-new" style={lp.newProgressStyle}>
                                                <div class="progress-fill-new"></div>
                                            </div>
                                        </div>
                                        <div class="progress-labels">
                                            <span class="label-completed">Completed</span>
                                            <span class="label-new">New Progress</span>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </template>
                        <template if:false={hasLocationProcesses}>
                            <div class="empty-lp">
                                <p>No location process data available</p>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </template>
    </div>
</template>