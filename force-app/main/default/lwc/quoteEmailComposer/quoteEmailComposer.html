<template>
    <section role="dialog" tabindex="-1" class="main-section">
        <div class="main-div">
            <div class="content-body">
                <div class="outer-grid">
                    
                    <div class="inner-grid-1 left-panel">
                        <div class="form-scroll-container">
                            
                            <div class="form-group">
                                <lightning-combobox
                                    name="template"
                                    label="Select Email Template"
                                    value={selectedTemplateId}
                                    placeholder="Select Template..."
                                    options={templateOptions}
                                    onchange={handleTemplateChange}
                                    required
                                    class="validate-field">
                                </lightning-combobox>
                            </div>

                            <div class="form-group">
                                <lightning-combobox
                                    name="fromAddress"
                                    label="From Address (Org-Wide Email)"
                                    value={selectedFromAddress}
                                    placeholder="Select From Address..."
                                    options={fromOptions}
                                    onchange={handleFromChange}
                                    required
                                    class="validate-field">
                                </lightning-combobox>
                            </div>

                            <div class="form-group">
                                <lightning-record-picker
                                    label="To"
                                    placeholder="Search Contact..."
                                    object-api-name="Contact"
                                    value={selectedToId}
                                    onchange={handleToChange}
                                    required
                                    class="validate-field">
                                </lightning-record-picker>
                            </div>

                            <div class="form-group">
                                <lightning-record-picker
                                    label="CC"
                                    placeholder="Search Contact..."
                                    object-api-name="Contact"
                                    value={selectedCcId}
                                    onchange={handleCcChange}>
                                </lightning-record-picker>
                            </div>

                            <div class="form-group">
                                <lightning-record-picker
                                    label="BCC"
                                    placeholder="Search Contact..."
                                    object-api-name="Contact"
                                    value={selectedBccId}
                                    onchange={handleBccChange}>
                                </lightning-record-picker>
                            </div>

                            <div class="form-group">
                                <lightning-input 
                                    label="Subject" 
                                    value={subject} 
                                    onchange={handleSubjectChange} 
                                    required
                                    class="validate-field">
                                </lightning-input>
                            </div>

                            <div class="form-group">
                                <lightning-input-rich-text
                                    label="Body"
                                    value={emailBody}
                                    onchange={handleBodyChange}
                                    required
                                    variant="bottom-toolbar"
                                    class="validate-field">
                                </lightning-input-rich-text>
                            </div>

                            <div class="form-group mt-3">
                                <label class="slds-form-element__label">Attachments</label>
                                
                                <input 
                                    type="file" 
                                    class="file-input-hidden" 
                                    onchange={handleFileSelect} 
                                    multiple 
                                    style="display:none;"
                                    data-id="fileInput"
                                />

                                <div class="attachment-box">
                                    <button class="upload-btn" onclick={triggerFileInput}>
                                        <lightning-icon icon-name="utility:upload" size="x-small" class="mr-1"></lightning-icon> 
                                        Upload Files
                                    </button>
                                    <span class="drag-text">Or drop files</span>
                                </div>

                                <div class="file-pills-container mt-2" if:true={hasFiles}>
                                    <template for:each={uploadedFiles} for:item="file" for:index="index">
                                        <lightning-pill 
                                            key={file.name} 
                                            label={file.name} 
                                            name={index} 
                                            onremove={handleRemoveFile}
                                            class="slds-m-right_xx-small slds-m-bottom_xx-small">
                                            <lightning-icon icon-name="doctype:attachment" size="x-small" alternative-text="Attachment"></lightning-icon>
                                        </lightning-pill>
                                    </template>
                                </div>
                            </div>

                        </div>
                    </div>

                    <div class="inner-grid-2 right-panel">
                        <div class="preview-scroll-container">
                            
                            <div class="accordion-item">
                                <div class="accordion-header" onclick={toggleBodyPreview}>
                                    <span>Email Body Preview</span>
                                    <lightning-icon icon-name={bodyPreviewIcon} size="x-small"></lightning-icon>
                                </div>
                                <div class={bodyPreviewClass}>
                                    <div class="preview-content">
                                        <lightning-formatted-rich-text value={emailBody}></lightning-formatted-rich-text>
                                        <div if:false={emailBody} class="slds-text-color_weak slds-text-align_center">
                                            Body is empty...
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="accordion-item mt-2">
                                <div class="accordion-header" onclick={toggleAttachmentPreview}>
                                    <span>Full Email Preview</span>
                                    <lightning-icon icon-name={attachmentPreviewIcon} size="x-small"></lightning-icon>
                                </div>
                                <div class={attachmentPreviewClass}>
                                    <div class="preview-content">
                                        <div class="preview-subject" if:true={subject}>
                                            <div class="slds-text-title_bold slds-m-bottom_xx-small">Subject:</div>
                                            <div class="slds-m-bottom_small">{subject}</div>
                                            <hr style="margin: 5px 0; border: 0; border-top: 1px solid #ddd;"/>
                                        </div>
                                        <lightning-formatted-rich-text value={emailBody}></lightning-formatted-rich-text>
                                        <div if:false={emailBody} class="slds-text-color_weak slds-text-align_center slds-p-around_medium">
                                            Select a template to view preview.
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>

            <div class="popUpFooter">
                <button 
                    class={sendButtonClass} 
                    onclick={handleSendEmail} 
                    disabled={isSendDisabled}>
                    Send Email
                </button>
                <button class="footer-btn primary-outline" onclick={handleClose}>Cancel</button>
            </div>
        </div>
    </section>
</template>