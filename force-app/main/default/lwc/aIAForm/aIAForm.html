<template>
	<!-- Hidden VF iframe for PDF generation -->
	<iframe src={vfPageUrl} class="vf-pdf-iframe" title="PDF Generator"></iframe>

	<!-- Modal popup: rendered only when isOpen is true -->
	<template if:true={isOpen}>
		<section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open">
			<div class="slds-modal__container modal">
				<!-- Modal header -->
				<header class="slds-modal__header modal-header">
					<button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse modal-close" 
							title="Close" onclick={close} aria-label="Close">
						<lightning-icon icon-name="utility:close" size="small" alternative-text="close"></lightning-icon>
						<span class="slds-assistive-text">Close</span>
					</button>
					<h2 id="aiBillTitle" class="slds-text-heading_medium">AIA Billing Form</h2>
				</header>
				
				<!-- Modal content -->
				<div class="slds-modal__content slds-p-around--medium modal-content" style="position: relative;">
					<template if:true={isLoading}>
						<div class="slds-spinner_container">
							<lightning-spinner alternative-text="Loading" size="medium" variant="brand"></lightning-spinner>
						</div>
					</template>
					<div class="pdf-viewer-container">
						<div class="pdf-canvas-container"></div>
					</div>
					<div class="pdf-content"></div>
					<div class={formContentClass} style="background-color: #ffffff; max-width: 100%; padding: 24px; margin: auto; font-family: Arial; font-size: 11pt; color: #000">
					<div class="page1">
						<div style="width: 100%; display:flex">
							<div style="width: 50%;font-weight: bold; font-size: 8pt;">APPLICATION AND CERTIFICATE FOR PAYMENT</div>
							<div style="width: 50%; font-size: 8pt;text-align: center;">AIA DOCUMENT G702</div>
						</div>
						<!-- <p style="font-weight: bold; font-size: 8pt"></p>
						<p style="text-align: center; font-size: 8pt">AIA DOCUMENT G702</p> -->
						<hr style="border: 1px solid #000" />
						<!-- Header Table -->
						<table style="border-collapse: collapse; width: 100%; font-size: 8pt; text-align: left">
							<tr>
								<td style="width: 9%; padding: 2pt" rowspan="2">TO CONTRACTOR:</td>
								<td style="width: 16%; padding: 2pt" rowspan="2">{acccountName} <br> {jobAddress}</td>
								<td style="width: 9%; padding: 2pt" rowspan="2">PROJECT:</td>
								<td style="width: 16%; padding: 2pt" rowspan="2">{project}</td>
								<td style="width: 9%; padding: 2pt">APPLICATION NO:</td>
								<td style="width: 16%; padding: 2pt">{applicationNo}</td>
								<td style="width: 9%; padding: 2pt">DISTRIBUTION TO:</td>
								<td style="width: 16%; padding: 2pt">{distributionTo}</td>
							</tr>
							<tr>
								<td style="padding: 2pt">PERIOD TO:</td>
								<td style="padding: 2pt">{billEndDate}</td>
								<td style="padding: 2pt">OWNER</td>
								<td style="padding: 2pt"><input type="checkbox"></td>
							</tr>
							<tr>
								<td style="padding: 2pt" rowspan="2">FROM SUBCONTRACTOR:</td>
								<td style="padding: 2pt" rowspan="2">{companyAddress}</td>
								<td style="padding: 2pt" rowspan="2">VIA ARCHITECT:</td>
								<td style="padding: 2pt" rowspan="2">{viaArchitect}</td>
								<td style="padding: 2pt">PROJECT NO:</td>
								<td style="padding: 2pt">{projectNo}</td>
								<td style="padding: 2pt">ARCHITECT</td>
								<td style="padding: 2pt"><input type="checkbox"></td>
							</tr>
							<tr>
								<td style="padding: 2pt">CONTRACT DATE:</td>
								<td style="padding: 2pt">{contractDate}</td>
								<td style="padding: 2pt">GENERAL</td>
								<td style="padding: 2pt"><input type="checkbox"></td>
							</tr>
							<tr>
								<td style="padding: 2pt">CONTRACT FOR:</td>
								<td style="padding: 2pt" colspan="7">&nbsp;</td>
							</tr>
						</table>

						<hr style="border: 1px solid #000" />
						<div style="display: flex; justify-content: space-between; flex-wrap: wrap">
							<div style="width: 45%; margin-right: 4%; min-width: 260px">
								<p style="font-weight: bold; font-size: 8pt">CONTRACTOR'S APPLICATION FOR PAYMENT</p>
								<p style="font-weight: bold; font-size: 8pt">Continuation Sheet, AIA Document G703, is attached.</p>
								<p style="font-size: 8pt">Application is made for payment, as shown below, in connection with the Contract.</p>

								<!-- Payment Summary Section -->
								<div style="font-size: 8pt; line-height: 1.5; margin-top: 10pt">
									<table style="width: 100%; border-collapse: collapse">
										<tr>
											<td style="width: 75%; padding: 3pt; font-size: 8pt;">1. ORIGINAL CONTRACT SUM</td>
											<td style="width: 25%; text-align: right; padding: 3pt; font-size: 8pt;">${totalContractValue}</td>
										</tr>
										<tr>
											<td style="padding: 3pt; font-size: 8pt;">2. Net change by Change Orders</td>
											<td style="text-align: right; padding: 3pt; font-size: 8pt;">${netchangebyChangeOrders}</td>
										</tr>
										<tr>
											<td style="padding: 3pt; font-size: 8pt;">3. CONTRACT SUM TO DATE (Line 1Â±2)</td>
											<td style="text-align: right; padding: 3pt; font-size: 8pt;">${contractSumToDate}</td>
										</tr>
										<tr>
											<td style="padding: 3pt; font-size: 8pt;">4. TOTAL COMPLETED &amp; STORED TO DATE (Column G on G703)</td>
											<td style="text-align: right; padding: 3pt; font-size: 8pt;">${totalBilledAmount}</td>
										</tr>
										<tr>
											<td style="padding: 3pt; font-size: 8pt;">5. RETAINAGE</td>
											<td style="text-align: right; padding: 3pt; font-size: 8pt;">&nbsp;</td>
										</tr>
										<tr>
											<td style="padding: 3pt; font-size: 8pt;">&nbsp;&nbsp;&nbsp;a. {wfreconRetainageOnBill}% of completed work (Column D+E on G703)</td>
											<td style="text-align: right; padding: 3pt; font-size: 8pt;">${retainageCompletedToDate}</td>
										</tr>
										<tr>
											<td style="padding: 3pt; font-size: 8pt;">&nbsp;&nbsp;&nbsp;b. % of Stored Material</td>
											<td style="text-align: right; padding: 3pt; font-size: 8pt;">$0.00</td>
										</tr>
										<tr>
											<td style="padding: 3pt; font-size: 8pt;">&nbsp;&nbsp;&nbsp;Total Retainage (Lines 5a + 5b or Total in Column I of G703)</td>
											<td style="text-align: right; padding: 3pt; font-size: 8pt;">${retainageCompletedToDate}</td>
										</tr>
										<tr>
											<td style="padding: 3pt; font-size: 8pt;">6. TOTAL EARNED LESS RETAINAGE (Line 4 Less Line 5 Total)</td>
											<td style="text-align: right; padding: 3pt; font-size: 8pt;">${totalAmountEarnedLessRetainage}</td>
										</tr>
										<tr>
											<td style="padding: 3pt; font-size: 8pt;">7. LESS PREVIOUS CERTIFICATES FOR PAYMENT (Line 6 from prior Certificate)</td>
											<td style="text-align: right; padding: 3pt; font-size: 8pt;">${lessPreviousCertificatedforPayment}</td>
										</tr>
										<tr>
											<td style="padding: 3pt; font-size: 8pt;">8. CURRENT PAYMENT DUE</td>
											<td style="text-align: right; padding: 3pt; font-size: 8pt;">${currentPaymentDue}</td>
										</tr>
										<tr>
											<td style="padding: 3pt; font-size: 8pt;">9. BALANCE TO FINISH, INCLUDING RETAINAGE (Line 3 less line 6)</td>
											<td style="text-align: right; padding: 3pt; font-size: 8pt;	">${balanceToFinishRetainage}</td>
										</tr>
									</table>
								</div>

								<!-- Change Order Summary Table -->
								<table style="border-collapse: collapse; width: 100%; font-size: 8pt; margin-top: 15pt">
									<tr>
										<td style="border: 1pt solid #000; padding: 5pt; background-color: #f3f3f3; font-weight: bold">CHANGE ORDER SUMMARY</td>
										<td style="border: 1pt solid #000; padding: 5pt; background-color: #f3f3f3; text-align: center; font-weight: bold">ADDITIONS</td>
										<td style="border: 1pt solid #000; padding: 5pt; background-color: #f3f3f3; text-align: center; font-weight: bold">DEDUCTIONS</td>
									</tr>
									<tr>
										<td style="border: 1pt solid #000; padding: 5pt; background-color: #f3f3f3">Total changes approved in previous months</td>
										<td style="border: 1pt solid #000; padding: 5pt; background-color: #f3f3f3; text-align: right">${previousAddition}</td>
										<td style="border: 1pt solid #000; padding: 5pt; background-color: #f3f3f3; text-align: right">${previousDeduction}</td>
									</tr>
									<tr>
										<td style="border: 1pt solid #000; padding: 5pt">Total Approved this Month</td>
										<td style="border: 1pt solid #000; padding: 5pt; text-align: right">${thisMonthAddition}</td>
										<td style="border: 1pt solid #000; padding: 5pt; text-align: right">${thisMonthDeduction}</td>
									</tr>
									<tr>
										<td style="border: 1pt solid #000; padding: 5pt">Totals</td>
										<td style="border: 1pt solid #000; padding: 5pt; text-align: right">${totalAddition}</td>
										<td style="border: 1pt solid #000; padding: 5pt; text-align: right">${totalDeduction}</td>
									</tr>
									<tr>
										<td style="border: 1pt solid #000; padding: 5pt">Net Changes by Change Orders</td>
										<td style="border: 1pt solid #000; padding: 5pt; text-align: right" >${netChanges}</td>
										<td style="border: 1pt solid #000; padding: 5pt; text-align: right" >&nbsp;&nbsp;&nbsp;</td>
									</tr>
								</table>
							</div>
							<div style="width: 45%; margin-left: 4%; min-width: 260px">
								<!-- Contractor certification block (preserved as requested) -->
								<div style="margin-top: 14px">
									<p style="margin: 0 0 6px 0; font-size: 8pt">The Undersigned Contractor certifies that to the best of the Contractor's knowledge information, and belief the Work covered by this Application for Payment has been completed in accordance with the Contract Documents, that all amounts have been paid by the Contractor for Work for which previous Certificates for Payment were issued and payments received from the Owner, and that current payment shown herein is now due.</p>

									<p style="margin: 8px 0 4px 0; font-size: 8pt">SUBCONTRACTOR: {comName}</p>
									<p style="margin: 6px 0 4px 0; font-size: 8pt">By:_______________________________ &nbsp;Date:______________________________</p>
									<p style="margin: 6px 0 4px 0; font-size: 8pt">State of:____________________________ County of: _________________________</p>
									<p style="margin: 6px 0 4px 0; font-size: 8pt">Subscribed and sworn to before me this____________ day of____________________,</p>
									<p style="margin: 6px 0 4px 0; font-size: 8pt">Notary Public: &nbsp; ________________________________________________________</p>
									<p style="margin: 6px 0 4px 0; font-size: 8pt">My Commission Expires On: _____________________________________________</p>
								</div>

								<!-- Architect's certificate block (preserved) -->
								<div style="margin-top: 12px">
									<p style="margin: 6px 0 4px 0; font-weight: bold; font-size: 8pt">ARCHITECT'S CERTIFICATE FOR PAYMENT</p>
									<p style="margin: 6px 0 4px 0; font-size: 8pt">In accordance with the Contract Documents, based on on-site observations and the data comprising the above application, the Architect certifies to the Owner that to the best of the Architect's knowledge, information and belief the Work has progressed as indicated, the quality of the Work is in accordance with the Contract Documents, and</p>
									<p style="margin: 6px 0 4px 0; font-size: 8pt">the Contractor is entitled to payment of the AMOUNT CERTIFIED.</p>
									<p style="margin: 8px 0 4px 0; font-size: 8pt">AMOUNT CERTIFIED..............................$</p>
									<p style="margin: 6px 0 4px 0; font-size: 8pt">(Attach explanation if amount certified differs from the amount applied. Initial all figures on this Application and onthe Continuation Sheet that are changed to conform with the amount certified.)</p>
									<p style="margin: 6px 0 4px 0; font-size: 8pt">ARCHITECT: {viaArchitect}&nbsp;</p>
									<p style="margin: 6px 0 4px 0; font-size: 8pt">By: &nbsp;________________________________ &nbsp;Date:________________________</p>
									<p style="margin: 6px 0 4px 0; font-size: 8pt">This Certificate is not negotiable. The AMOUNT CERTIFIED is payable only to the Contractor named herein.Issuance, payment and acceptance of payment are without prejudice to any rights of the Owner or Contractor under this Contract.</p>
								</div>
							</div>
						</div>
					</div>
					<div class="html2pdf__page-break"></div>		
					<div class="page2" >
						<div style="width: 100%; display:flex; justify-content: space-between;">
							<div style="font-weight: bold; font-size: 8pt;">SCHEDULE OF VALUES</div>
							<div style="font-weight: bold; font-size: 8pt;">Page 2</div>
						</div>
						<hr style="border: 1px solid #000" />
						<table role="presentation" style="width: 100%; border-collapse: collapse; margin-top: 14px">
							<tr>
								<td style="width:12%; padding: 8px; font-size: 8pt;">Project:</td>
								<td style="width:35%; border-bottom: 1px solid #8c8c8c; padding: 8px; font-size: 8pt;">{project}</td>
								<td style="width:16%; font-size: 8pt;">&nbsp;</td>
								<td style="width:12%; padding: 8px; font-size: 8pt;">Application #:</td>
								<td style="width:25%; border-bottom: 1px solid #8c8c8c; padding: 8px; font-size: 8pt;">{applicationNo}</td>
							</tr>
							<tr>
								<td style="padding: 8px; font-size: 8pt; font-size: 8pt;">Subcontract:</td>
								<td style="border-bottom: 1px solid #8c8c8c; padding: 8px; font-size: 8pt;">{comName}</td>
								<td >&nbsp;</td>
								<td style="padding: 8px; font-size: 8pt;">Period To:</td>
								<td style="border-bottom: 1px solid #8c8c8c; padding: 8px; font-size: 8pt;">{billEndDate}</td>
							</tr>
							<tr>
								<td style="padding: 8px; font-size: 8pt;">Vendor ID:</td>
								<td style="border-bottom: 1px solid #8c8c8c; padding: 8px; font-size: 8pt;">&nbsp;</td>
								<td>&nbsp;</td>
								<td style="padding: 8px; font-size: 8pt;">Application Date:</td>
								<td style="border-bottom: 1px solid #8c8c8c; padding: 8px; font-size: 8pt;">{contractDate}</td>
							</tr>
						</table>

						<p style="margin: 10pt 0pt 10pt 0pt; font-size: 8pt; font-weight: bold;">Subcontractor Application for Payment containing Subcontractor's signature is attached.</p>

						<table role="presentation" style="width: 100%; border-collapse: collapse; margin-top: 8pt">
							<tr>
								<td style="background-color:#dfdcdc; border: 1px solid #000; padding: 4pt; text-align: center; width: 4%; font-size: 8pt; font-weight: bold;">A</td>
								<td style="background-color:#dfdcdc; border: 1px solid #000; padding: 4pt; text-align: center; width: 23%; font-size: 8pt; font-weight: bold;">B</td>
								<td style="background-color:#dfdcdc; border: 1px solid #000; padding: 4pt; text-align: center; width: 7%; font-size: 8pt; font-weight: bold;">C</td>
								<td style="background-color:#dfdcdc; border: 1px solid #000; padding: 4pt; text-align: center; width: 7%; font-size: 8pt; font-weight: bold;">D</td>
								<td style="background-color:#dfdcdc; border: 1px solid #000; padding: 4pt; text-align: center; width: 7%; font-size: 8pt; font-weight: bold;">E</td>
								<td style="background-color:#dfdcdc; border: 1px solid #000; padding: 4pt; text-align: center; width: 7%; font-size: 8pt; font-weight: bold;">F</td>
								<td style="background-color:#dfdcdc; border: 1px solid #000; padding: 4pt; text-align: center; width: 7%; font-size: 8pt; font-weight: bold;">G</td>
								<td style="background-color:#dfdcdc; border: 1px solid #000; padding: 4pt; text-align: center; width: 7%; font-size: 8pt; font-weight: bold;">H</td>
								<td style="background-color:#dfdcdc; border: 1px solid #000; padding: 4pt; text-align: center; width: 7%; font-size: 8pt; font-weight: bold;">I</td>
								<td style="background-color:#dfdcdc; border: 1px solid #000; padding: 4pt; text-align: center; width: 7%; font-size: 8pt; font-weight: bold;">J</td>
							</tr>
						</table>
						<div class="dynamic-container"></div>
						<div class="dynamic-container-2tabel"></div>
						<table role="presentation" style="width: 100%; border-collapse: collapse; margin-top: 8px">
							<!-- <tr>
								<td style="background-color:#dfdcdc; border:1px solid #000; text-align:center; width:4%; font-size:8pt; font-weight:bold; padding:4pt 0pt;">&nbsp;</td>
								<td style="background-color:#dfdcdc; border:1px solid #000; text-align:center; width:23%; font-size:8pt; font-weight:bold; padding:4pt 0pt;">&nbsp;</td>
								<td style="background-color:#dfdcdc; border:1px solid #000; text-align:center; width:7%; font-size:8pt; font-weight:bold; padding:4pt 0pt;">&nbsp;</td>
								<td style="background-color:#dfdcdc; border:1px solid #000; text-align:center; width:7%; font-size:8pt; font-weight:bold; padding:4pt 0pt;">&nbsp;</td>
								<td style="background-color:#dfdcdc; border:1px solid #000; text-align:center; width:7%; font-size:8pt; font-weight:bold; padding:4pt 0pt;">&nbsp;</td>
								<td style="background-color:#dfdcdc; border:1px solid #000; text-align:center; width:7%; font-size:8pt; font-weight:bold; padding:4pt 0pt;">&nbsp;</td>
								<td style="background-color:#dfdcdc; border:1px solid #000; text-align:center; width:7%; font-size:8pt; font-weight:bold; padding:4pt 0pt;">&nbsp;</td>
								<td style="background-color:#dfdcdc; border:1px solid #000; text-align:center; width:7%; font-size:8pt; font-weight:bold; padding:4pt 0pt;">&nbsp;</td>
								<td style="background-color:#dfdcdc; border:1px solid #000; text-align:center; width:7%; font-size:8pt; font-weight:bold; padding:4pt 0pt;">&nbsp;</td>
								<td style="background-color:#dfdcdc; border:1px solid #000; text-align:center; width:7%; font-size:8pt; font-weight:bold; padding:4pt 0pt;">&nbsp;</td>
							</tr> -->
							<tr>
								<!-- <td style="border: 1pt solid #000; padding: 4pt; font-size: 8pt; font-weight: bold;background-color:#dfdcdc; width: 4%">&nbsp;</td> -->
								<td style="border: 1pt solid #000; padding: 4pt; font-size: 8pt; font-weight: bold;background-color:#dfdcdc; width:27%;" colspan="2">Total</td>
								<td style="border: 1pt solid #000; padding: 4pt; font-size: 8pt; font-weight: bold;background-color:#dfdcdc; width:7%">${totalC}</td>
								<td style="border: 1pt solid #000; padding: 4pt; font-size: 8pt; font-weight: bold;background-color:#dfdcdc; width:7%">${totalD}</td>
								<td style="border: 1pt solid #000; padding: 4pt; font-size: 8pt; font-weight: bold;background-color:#dfdcdc; width:7%">${totalE}</td>
								<td style="border: 1pt solid #000; padding: 4pt; font-size: 8pt; font-weight: bold;background-color:#dfdcdc; width:7%">${totalF}</td>
								<td style="border: 1pt solid #000; padding: 4pt; font-size: 8pt; font-weight: bold;background-color:#dfdcdc; width:7%">-</td>
								<td style="border: 1pt solid #000; padding: 4pt; font-size: 8pt; font-weight: bold;background-color:#dfdcdc; width:7%">${totalH}</td>
								<td style="border: 1pt solid #000; padding: 4pt; font-size: 8pt; font-weight: bold;background-color:#dfdcdc; width:7%">${totalI}</td>
								<td style="border: 1pt solid #000; padding: 4pt; font-size: 8pt; font-weight: bold;background-color:#dfdcdc; width:7%">${totalJ}</td>
							</tr>
						</table>
						<hr style="border: 1px solid #000; margin-top: 10px" />
					</div>
					</div>
				</div>
				
				<!-- Modal Footer -->
				<footer class="slds-modal__footer modal-footer" if:true={pdfUrl}>
					<a href={pdfUrl} download="AIA-Billing-Form.pdf" class="btn-download-pdf">
						<lightning-icon icon-name="utility:download" size="x-small"></lightning-icon>
						Download PDF
					</a>
				</footer>
			</div>
		</section>
		<!-- Modal Backdrop -->
		<div class="slds-backdrop slds-backdrop_open"></div>
	</template>
</template>