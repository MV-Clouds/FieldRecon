<template>
  <div class="spinner-container slds-is-fixed" if:true={isSpinner}>
    <lightning-spinner alternative-text="Loading..." size="medium"></lightning-spinner>
  </div>
  <div class="slds-grid slds-grid--vertical slds-card main-calendar-div">
    <div class="header">
      <div class="title-text slds-text-heading--medium">
        Mobilization Calendar
      </div>
      <div class="filters-and-search slds-grid">
        <div class="status-filter-picklist">
          <div class="status-picklist-label">
            Status
            <lightning-icon icon-name='utility:check' alternative-text='check' size='xx-small' variant="success" title='check' lwc:if={filterStatus.length}></lightning-icon>
            <lightning-icon icon-name='utility:down' alternative-text='down' size='xx-small' title='down' lwc:else></lightning-icon>
          </div>
          <div class="status-options-selection-div slds-is-absolute">
            <template for:each={statusOptions} for:item="opt">
              <div class="status-options" key={opt.value} data-value={opt.value} data-selected={opt.isSelected} onclick={handleFilter}>{opt.label}</div>
            </template>
          </div>
        </div>
        <lightning-record-picker
          variant="label-hidden"
          label="Jobs"
          placeholder="Search Jobs..."
          object-api-name="wfrecon__Job__c"
          display-info={displayJobs}
          matching-info={matchingJobs}
          name="jobId"
          value={filterjobs}
          onchange={handleFilter}>
        </lightning-record-picker>
      </div>
    </div>
    <div style="background:#ffffff;" class="slds-grid">
      <div id="calendar" class="fullcalendarjs"></div>
    </div>
  </div>
  <!-- <lightning-spinner class="slds-is-fixed" if:true={isSpinner} style="z-index: 9999;"></lightning-spinner> -->
  <template if:true={openModal}>
    <section role="dialog" class="slds-modal slds-fade-in-open">
        <div class="slds-modal__container mob-popup">
            <header class="slds-modal__header mob-popup-header">
              <button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse" title="Close"
              onclick={handleModalClose}>
              <lightning-icon icon-name="utility:close" size="small" alternative-text="close"
                class="slds-button__icon slds-button__icon_large"></lightning-icon>
              <span class="slds-assistive-text">Close</span>
            </button>
                <h2 class="slds-text-heading_medium" if:false={isEdit}>{Heading}</h2>
                <div class="slds-text-heading_medium" if:true={isEdit}>
                  Edit Mobilization Group
                </div>
            </header>
            <div class="slds-modal__content mob-popup-body">
            <lightning-record-edit-form class="mob-group-form" object-api-name="wfrecon__Mobilization_Group__c" record-id={selectedEventId} onsuccess={handleSuccess} onsubmit={handleMobFormSubmitted}>
              <div class="main-mob-group-popup-form">
                <div class="fields-input-div slds-grow slds-scrollable--y slds-grid slds-wrap slds-p-horizontal--medium">
                  <div class="job-label-link slds-p-horizontal--xx-small slds-size--1-of-1" if:true={isEdit}> <span class="slds-form-element__label job-label">Job: </span> <span data-id={jobId} class="record-nav-link" onclick={navigateToRecord}>{jobName}</span></div>
                  <lightning-input-field field-name="wfrecon__Job__c" if:false={isEdit} value={jobId}> </lightning-input-field>
                  <div class="slds-size--1-of-1 date-field-in-mob-form">
                    <lightning-input-field field-name="wfrecon__Start_Date__c" value={startDateTime}> </lightning-input-field>
                  </div>
                  <div class="slds-size--1-of-1 date-field-in-mob-form">
                    <lightning-input-field field-name="wfrecon__End_Date__c" value={endDateTime}> </lightning-input-field>
                  </div>
                  <div class="slds-grid slds-size--1-of-1">
                    <div class="slds-large-size--1-of-3 slds-medium-size--1-of-2 slds-size--1-of-2">
                        <lightning-input-field field-name="wfrecon__Include_Saturday__c" value={includeSaturday}> </lightning-input-field>
                    </div>
                    <div class="slds-large-size--1-of-3 slds-medium-size--1-of-2 slds-size--1-of-2">
                        <lightning-input-field field-name="wfrecon__Include_Sunday__c" value={includeSunday}> </lightning-input-field>
                    </div>
                  </div>
                  <lightning-input-field field-name="wfrecon__Mobilization_Status__c"> </lightning-input-field>
                  <lightning-input-field field-name="wfrecon__Description__c" value={description}> </lightning-input-field>
                </div>
                <div class="slds-grid slds-grid--align-center slds-p-vertical--medium bottom-footer-btn">
                    <button class="assign-btn footer-btn" type="button" if:true={isEdit} onclick={handleResourceAssign}>Assign Resources</button>
                    <button class="slds-m-left--small delete-btn footer-btn" type="button" if:true={isEdit} onclick={handleDeleteMobilization}>Delete</button>
                    <button class="slds-m-left--small save-btn footer-btn" type="submit">Save</button>
                </div>
              </div>
            </lightning-record-edit-form>
            </div>
        </div>
    </section>
    <div class="slds-backdrop slds-backdrop_open"></div>
  </template>
  <template if:true={showConfirmationPopup}>
    <div class="slds-container_small confirm-popup">
      <section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open">
        <div class="slds-modal__container">
          <header class="slds-modal__header confirm-popup-header">
            <h2 class="slds-text-heading_medium slds-hyphenate">{confirmationTitle}</h2>
          </header>
          <div class="slds-modal__content slds-p-around_medium confirm-popup-body slds-text-align--center" >
            <p>{confirmationMessage}</p>
            <div class="slds-grid slds-grid--align-center slds-p-top--medium confirm-popup-btns">
              <button class="save-btn confirmation-cancel-btn" name="cancel" onclick={handleClose}>Cancel</button>
              <button class="save-btn" name="confirm" onclick={handleEventDrop}>Confirm</button>
            </div>
          </div>
        </div>
      </section>
      <div class="slds-backdrop slds-backdrop_open confirmation-backdrop"></div>
    </div>
  </template>

  <!-- The Resource Assignment Popup -->
  <template if:true={showResourceAssignPopup}>
    <section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open resource-assign-popup">
      <div class="slds-modal__container mob-popup">
        <!-- Modal header -->
        <header class="slds-modal__header mob-popup-header">
          <button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse" title="Close"
            onclick={handleCancelEdit}>
            <lightning-icon icon-name="utility:close" size="small" alternative-text="close"
              class="slds-button__icon slds-button__icon_large"></lightning-icon>
            <span class="slds-assistive-text">Close</span>
          </button>
          <h2 class="slds-text-heading_medium">Assign Resources</h2>
        </header>

        <!-- Modal content -->
        <div class="slds-modal__content slds-p-around--medium mob-popup-body">
            <div class="main-resources-edit-div">
              <div class="tabs sub-tabs tab-navigation">
                <button class="nav-tab-btn" data-selected={resourceTypeForAssign} name="Crew" data-for="assign" onclick={selectResourceType}>Crew</button>
                <button class="nav-tab-btn" data-selected={resourceTypeForAssign} name="SubContractor" data-for="assign" onclick={selectResourceType}>Sub
                  Contractors</button>
                <button class="nav-tab-btn" data-selected={resourceTypeForAssign} name="Asset" data-for="assign" onclick={selectResourceType}>Assets</button>
              </div>
              <div class="search-resources-div slds-size--1-of-1">
                <lightning-input
                  type="search"
                  value={resourceSearchKey}
                  variant="label-hidden"
                  placeholder="Search Resource Name"
                  onchange={handleResourceSearch}
                ></lightning-input>
              </div>
              <div class="select-and-add-div slds-grow">
                <div class="resource-list-div">
                  <template for:each={resourceOptionsToShow} for:item="opt" lwc:if={isCrewAssignOpen}>
                    <div key={opt.id} class="checkboxes-select options-with-crew-and-members" style={opt.bgStyle}>
                      <div class="whole-crew-selection-checkbox">
                        <input 
                          class="resource-option-checkbox"
                          type="checkbox"
                          data-id={opt.id}
                          checked={opt.isSelected}
                          onchange={handleSelectWholeCrew}
                          id={opt.name}
                        ></input>
                        <label class="checkbox-option-label whole-crew-title-checkbox" title={opt.name} for={opt.name} data-available={opt.isAvailable}>{opt.name}</label>
                      </div>
                      <div class="crew-members-list slds-grid slds-grid--vertical">
                        <template for:each={opt.members} for:item="member">
                          <div key={member.id} class="checkboxes-select">
                            <input 
                              class="resource-option-checkbox"
                              type="checkbox"
                              data-id={member.id}
                              data-crewid={opt.id}
                              data-type="Crew"
                              checked={member.isSelected}
                              onchange={handleSelectResourceOption}
                              id={member.name}
                            ></input>
                            <label class="checkbox-option-label" for={member.name} data-available={member.isAvailable}>{member.name}</label>
                          </div>
                        </template>
                      </div>
                    </div>
                  </template>
                  <template for:each={resourceOptionsToShow} for:item="opt" lwc:else>
                    <div key={opt.id} class="checkboxes-select">
                      <input 
                        class="resource-option-checkbox"
                        type="checkbox"
                        data-id={opt.id}
                        checked={opt.isSelected}
                        onchange={handleSelectResourceOption}
                        id={opt.name}
                      ></input>
                      <label class="checkbox-option-label" for={opt.name} data-available={opt.isAvailable}>{opt.name}</label>
                    </div>
                  </template>
                  <template if:false={resourceOptionsToShow.length}>
                    <div class="empty-state-msg">
                      <img src="/resource/wfrecon__emptyState" alt="empty state">
                      <div class="empty-state-msg-text">
                        No Resources To Display!
                      </div>
                    </div>
                  </template>
                </div>
              </div>
              <div class="add-btn" onclick={addResourceForAssignment}>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="20" height="20" fill="white"><path d="M352 128C352 110.3 337.7 96 320 96C302.3 96 288 110.3 288 128L288 288L128 288C110.3 288 96 302.3 96 320C96 337.7 110.3 352 128 352L288 352L288 512C288 529.7 302.3 544 320 544C337.7 544 352 529.7 352 512L352 352L512 352C529.7 352 544 337.7 544 320C544 302.3 529.7 288 512 288L352 288L352 128z"/></svg>
              </div>
              <!-- <div class="selected-tiles-heading">
                <b>Selected Resources: </b>
              </div>
              <div class="selected-record-tiles">
                <template for:each={addedResources} for:item="tile">
                    <span class="subcontractor-item tile" key={tile.id}>
                        <div class="slds-truncate" title={tile.name}>{tile.name}</div>
                        <svg class="remove-btn-svg" data-job={mobIdForResources} data-id={tile.id} onclick={handleRemoveJobResource} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="16" height="16" fill="#5a5adb"><path d="M183.1 137.4C170.6 124.9 150.3 124.9 137.8 137.4C125.3 149.9 125.3 170.2 137.8 182.7L275.2 320L137.9 457.4C125.4 469.9 125.4 490.2 137.9 502.7C150.4 515.2 170.7 515.2 183.2 502.7L320.5 365.3L457.9 502.6C470.4 515.1 490.7 515.1 503.2 502.6C515.7 490.1 515.7 469.8 503.2 457.3L365.8 320L503.1 182.6C515.6 170.1 515.6 149.8 503.1 137.3C490.6 124.8 470.3 124.8 457.8 137.3L320.5 274.7L183.1 137.4z"/></svg>
                    </span>
                </template>
                <template if:false={addedResources.length}>
                    <div class="no-resource-text-div">
                        No {resourceTypeForAssign} has been assigned yet.
                    </div>
                </template>
              </div> -->
            </div>
        </div>
      </div>
    </section>
    <!-- Modal Backdrop -->
    <div class="slds-backdrop slds-backdrop_open resource-assign-backdrop"></div>
  </template>

  <template if:true={showConfirmationPopup}>
    <div class="slds-container_small confirm-popup">
      <section role="dialog" tabindex="-1" class="confirmation-popup-div slds-modal slds-fade-in-open">
        <div class="slds-modal__container">
          <header class="slds-modal__header confirm-popup-header">
            <h2 class="slds-text-heading_medium slds-hyphenate">{confirmationTitle}</h2>
          </header>
          <div class="slds-modal__content slds-p-around_medium confirm-popup-body slds-text-align--center" >
            <p class="slds-p-bottom--medium">{confirmationMessage}</p>
            <div class="slds-grid slds-grid--align-center slds-p-vertical--medium confirm-popup-btns bottom-footer-btn">
              <button class="save-btn confirmation-cancel-btn" name="cancel" onclick={handleConfirmationAction}>Cancel</button>
              <button class="save-btn" name="confirm" onclick={handleConfirmationAction}>{confirmationBtnLabel}</button>
              <button class="save-btn" name="secondOption" onclick={handleConfirmationAction} if:true={confirmationBtnLabel2}>{confirmationBtnLabel2}</button>
            </div>
          </div>
        </div>
      </section>
      <div class="slds-backdrop slds-backdrop_open confirmation-backdrop"></div>
    </div>
  </template>
</template>