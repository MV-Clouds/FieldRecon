<template>
    <div class="shift-end-log-container">
        <div class="header-fixed-div">
            <div class="filter-search-container">
                <div class="search-bar">
                    <lightning-input type="search" placeholder="Search by name or person..." value={searchTerm} onchange={handleSearch} variant="label-hidden" class="search-bar-input"></lightning-input>
                </div>
                <div class="right-controls">
                    <div class="create-btn" onclick={handleCreate}>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" width="14" height="14" fill="white"><path d="M256 80c0-17.7-14.3-32-32-32s-32 14.3-32 32V224H48c-17.7 0-32 14.3-32 32s14.3 32 32 32H192V432c0 17.7 14.3 32 32 32s32-14.3 32-32V288H400c17.7 0 32-14.3 32-32s-14.3-32-32-32H256V80z"/></svg>
                        Create Log
                    </div>
                </div>
            </div>
        </div>
        <div class="spinner-container slds-is-fixed" if:true={isLoading}>
            <lightning-spinner alternative-text="Loading..." size="medium"></lightning-spinner>
        </div>

        
        <template if:true={hasError}>
            <div class="empty-state">
                <div class="empty-state__content">
                    <div class="empty-state__icon">
                        <img src="/resource/wfrecon__emptyState" alt="" draggable="false">
                    </div>
                    <div class="empty-state__message">{errorMessage}</div>
                </div>
            </div>
        </template>
        <template if:false={isLoading}>
            <template if:false={hasError}>
                <template if:false={hasLogs}>
                    <div class="empty-state">
                        <div class="empty-state__content">
                            <div class="empty-state__icon">
                                <img src="/resource/wfrecon__emptyState" alt="" draggable="false">
                            </div>
                            <div class="empty-state__message">{noLogsMessage}</div>
                        </div>
                    </div>
                </template>
            </template>
        </template>
        
        <template if:true={hasLogs}>
            <div class="logs-grid">
                <template for:each={displayedLogs} for:item="log">
                    <div key={log.Id} class="card-placeholder">
                        <div class="log-card" data-id={log.Id}>
                            <div class="log-card-header">
                                <div class="log-header-detail">
                                    <div class="log-card-name-status">
                                        <div class="log-card-name" data-id={log.Id}>{log.Name}</div>
                                        <div class="log-card-date">{log.formattedDate}</div>
                                    </div>
                                </div>
                                <div class="action-btns">
                                    <div class="edit-btn btn action-btn" data-id={log.Id} onclick={handleEdit}>
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M471.6 21.7c-21.9-21.9-57.3-21.9-79.2 0L362.3 51.7l97.9 97.9 30.1-30.1c21.9-21.9 21.9-57.3 0-79.2L471.6 21.7zm-299.2 220c-6.1 6.1-10.8 13.6-13.5 21.9l-29.6 88.8c-2.9 8.6-.6 18.1 5.8 24.6s15.9 8.7 24.6 5.8l88.8-29.6c8.2-2.7 15.7-7.4 21.9-13.5L437.7 172.3 339.7 74.3 172.4 241.7zM96 64C43 64 0 107 0 160V416c0 53 43 96 96 96H352c53 0 96-43 96-96V320c0-17.7-14.3-32-32-32s-32 14.3-32 32v96c0 17.7-14.3 32-32 32H96c-17.7 0-32-14.3-32-32V160c0-17.7 14.3-32 32-32h96c17.7 0 32-14.3 32-32s-14.3-32-32-32H96z"/></svg>
                                    </div>
                                    <div class="delete-btn btn action-btn" data-id={log.Id} data-name={log.Name} onclick={handleDelete}>
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M135.2 17.7L128 32H32C14.3 32 0 46.3 0 64S14.3 96 32 96H416c17.7 0 32-14.3 32-32s-14.3-32-32-32H320l-7.2-14.3C307.4 6.8 296.3 0 284.2 0H163.8c-12.1 0-23.2 6.8-28.6 17.7zM416 128H32L53.2 467c1.6 25.3 22.6 45 47.9 45H346.9c25.3 0 46.3-19.7 47.9-45L416 128z"/></svg>
                                    </div>
                                </div>
                            </div>
                            <div class="log-meta-info">
                                <div class="log-meta-info-name">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" width="14" height="14"><path d="M224 256A128 128 0 1 0 224 0a128 128 0 1 0 0 256zm-45.7 48C79.8 304 0 383.8 0 482.3C0 498.7 13.3 512 29.7 512H418.3c16.4 0 29.7-13.3 29.7-29.7C448 383.8 368.2 304 269.7 304H178.3z"/></svg>
                                    <span>{log.createdByName}</span>
                                </div>
                            </div>
                            <div class="section-label">Work Performed:</div>
                            <div class="work-content">{log.displayWorkPerformed}</div>
                            
                            <div class="section-label">Exceptions:</div>
                            <div class={log.exceptionContentClass}>{log.displayExceptions}</div>
                            
                            <div class="section-label">Plan for Tomorrow:</div>
                            <div class="plan-content">{log.displayPlanForTomorrow}</div>
                            
                            <div class="section-label">Notes to Office:</div>
                            <div class="plan-content">{log.displayNotesToOffice}</div>
                            <template if:true={log.hasImages}>
                                <div class="section-label images-label">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="14" height="14"><path d="M0 96C0 60.7 28.7 32 64 32H448c35.3 0 64 28.7 64 64V416c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V96zM323.8 202.5c-4.5-6.6-11.9-10.5-19.8-10.5s-15.4 3.9-19.8 10.5l-87 127.6L170.7 297c-4.6-5.7-11.5-9-18.7-9s-14.2 3.3-18.7 9l-64 80c-5.8 7.2-6.9 17.1-2.9 25.4s12.4 13.6 21.6 13.6h96 32H424c8.9 0 17.1-4.9 21.2-12.8s3.6-17.4-1.4-24.7l-120-176zM112 192a48 48 0 1 0 0-96 48 48 0 1 0 0 96z"/></svg>
                                    <span>Images ({log.imageCount})</span>
                                </div>
                                <div class="images-grid">
                                    <template for:each={log.images} for:item="image">
                                        <div key={image.Id} class="image-thumbnail" data-id={image.ContentDocumentId} data-version-id={image.Id} onclick={handleImagePreview}>
                                            <img src={image.thumbnailUrl} alt={image.Title} />
                                        </div>
                                    </template>
                                </div>
                            </template>
                        </div>
                    </div>

                </template>
            </div>
        </template>

        <template if:true={hasLogs}>
            <!-- Pagination Section -->
            <div class="pagination-section">
                <div class="pagination-container">
                    <button 
                        class="pagination-button" 
                        onclick={handlePrevious} 
                        disabled={isFirstPage}>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Previous
                    </button>
                    
                    <template for:each={pageNumbers} for:item="page">
                        <template if:false={page.isEllipsis}>
                            <button 
                                key={page.number}
                                class={page.cssClass}
                                data-page={page.number}
                                onclick={handlePageChange}>
                                {page.number}
                            </button>
                        </template>
                        <template if:true={page.isEllipsis}>
                            <span key={page.number} class="pagination-ellipsis">...</span>
                        </template>
                    </template>
                    
                    <button 
                        class="pagination-button" 
                        onclick={handleNext} 
                        disabled={isLastPage}>
                        Next
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
            </div>
        </template>
    </div>

    <!-- Edit Modal Popup -->
    <template if:true={showEditModal}>
        <section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open shift-end-edit-modal">
            <div class="slds-modal__container edit-modal">
                <!-- Modal header -->
                <header class="slds-modal__header edit-modal-header">
                    <button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse" 
                            title="Close" 
                            onclick={handleCloseModal}>
                        <lightning-icon icon-name="utility:close" size="small" alternative-text="close"
                                        class="slds-button__icon slds-button__icon_large"></lightning-icon>
                        <span class="slds-assistive-text">Close</span>
                    </button>
                    <h2 class="slds-text-heading_medium">Edit Shift End Log</h2>
                </header>

                <!-- Modal content -->
                <div class="slds-modal__content slds-p-around--medium edit-modal-body">
                    <form onsubmit={handleSaveEdit}>
                        <!-- Work Performed Date Field -->
                        <div class="slds-m-bottom_medium">
                            <lightning-input
                                type="date"
                                label="Work Performed Date"
                                value={editFormData.workPerformedDate}
                                data-field="workPerformedDate"
                                onchange={handleEditInputChange}
                                required>
                            </lightning-input>
                        </div>

                        <!-- Work Performed Field -->
                        <div class="slds-m-bottom_medium">
                            <lightning-textarea
                                label="Work Performed"
                                value={editFormData.workPerformed}
                                data-field="workPerformed"
                                onchange={handleEditInputChange}
                                placeholder="Enter work performed details..."
                                max-length="32000"
                                required>
                            </lightning-textarea>
                        </div>

                        <!-- Plan for Tomorrow Field -->
                        <div class="slds-m-bottom_medium">
                            <lightning-textarea
                                label="Plan for Tomorrow"
                                data-field="planForTomorrow"
                                value={editFormData.planForTomorrow}
                                onchange={handleEditInputChange}
                                placeholder="Enter plan for tomorrow..."
                                max-length="32000"
                                required>
                            </lightning-textarea>
                        </div>

                        <!-- Exceptions Field (Optional) -->
                        <div class="slds-m-bottom_medium">
                            <lightning-textarea
                                label="Exceptions"
                                value={editFormData.exceptions}
                                data-field="exceptions"
                                onchange={handleEditInputChange}
                                placeholder="Enter any exceptions (Optional)..."
                                max-length="32000">
                            </lightning-textarea>
                        </div>

                        <!-- Notes to Office Field (Optional) -->
                        <div class="slds-m-bottom_medium">
                            <lightning-textarea
                                label="Notes to Office"
                                data-field="notesToOffice"
                                value={editFormData.notesToOffice}
                                onchange={handleEditInputChange}
                                placeholder="Enter notes to office..."
                                max-length="32000">
                            </lightning-textarea>
                        </div>

                        <!-- Image Gallery Section -->
                        <div class="slds-m-bottom_medium gallery-section">
                            <div class="section-label images-label">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="14" height="14" fill="currentColor">
                                    <path d="M0 96C0 60.7 28.7 32 64 32H448c35.3 0 64 28.7 64 64V416c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V96zM323.8 202.5c-4.5-6.6-11.9-10.5-19.8-10.5s-15.4 3.9-19.8 10.5l-87 127.6L170.7 297c-4.6-5.7-11.5-9-18.7-9s-14.2 3.3-18.7 9l-64 80c-5.8 7.2-6.9 17.1-2.9 25.4s12.4 13.6 21.6 13.6h96 32H424c8.9 0 17.1-4.9 21.2-12.8s3.6-17.4-1.4-24.7l-120-176zM112 192a48 48 0 1 0 0-96 48 48 0 1 0 0 96z"/>
                                </svg>
                                Images
                            </div>
                            
                            <!-- Upload Options -->
                            <div class="upload-options">
                                <div class="upload-left">
                                    <lightning-file-upload
                                        label="Upload Images"
                                        name="imageUpload"
                                        accept={acceptedFormats}
                                        record-id={editLogId}
                                        onuploadfinished={handleUploadFinished}
                                        multiple>
                                    </lightning-file-upload>
                                </div>
                                <template if:true={isDesktopDevice}>
                                    <div class="upload-right">
                                        <button type="button" class="upload-btn camera-btn" onclick={handleOpenCamera} title="Capture Photo">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="16" height="16" fill="white">
                                                <path d="M149.1 64.8L138.7 96H64C28.7 96 0 124.7 0 160V416c0 35.3 28.7 64 64 64H448c35.3 0 64-28.7 64-64V160c0-35.3-28.7-64-64-64H373.3L362.9 64.8C356.4 45.2 338.1 32 317.4 32H194.6c-20.7 0-39 13.2-45.5 32.8zM256 192a96 96 0 1 1 0 192 96 96 0 1 1 0-192z"/>
                                            </svg>
                                            Capture Photo
                                        </button>
                                    </div>
                                </template>
                            </div>                            
                            <!-- Image Display Grid -->
                            <template if:true={hasImages}>
                                <div class="photo-grid">
                                    <template for:each={allImages} for:item="image">
                                        <div key={image.id} class="photo-item">
                                            <img src={image.url} 
                                                 alt={image.name} 
                                                 class="photo-thumbnail" 
                                                 loading="lazy"
                                                 data-id={image.id}
                                                 data-version-id={image.versionId}
                                                 onclick={handleModalImagePreview} />
                                            <button 
                                                class="remove-photo-btn" 
                                                data-id={image.id}
                                                data-existing={image.isExisting}
                                                data-camera={image.isCamera}
                                                onclick={handleRemoveImage}
                                                title="Remove image">
                                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" width="12" height="12" fill="white">
                                                    <path d="M342.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L192 210.7 86.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L146.7 256 41.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L192 301.3 297.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L237.3 256 342.6 150.6z"/>
                                                </svg>
                                            </button>
                                            <div class="photo-name">{image.name}</div>
                                        </div>
                                    </template>
                                </div>
                            </template>
                        </div>
                    </form>
                </div>
                
                <!-- Control buttons - Sticky Footer -->
                <div class="bottom-footer-btn">
                    <button class="save-btn" type="button" onclick={handleSaveEdit} disabled={isLoading}>
                        Update
                    </button>
                </div>
            </div>
        </section>
        <!-- Modal Backdrop -->
        <div class="slds-backdrop slds-backdrop_open"></div>
    </template>

    <template if:true={showEntryPopup}>
        <c-shift-end-log-entries onclose={handleCloseEntryPopup} job-id={recordId} crew-leader-id={crewLeaderId} crew-ids={crewIds} ></c-shift-end-log-entries>
    </template>

    <!-- Camera Modal -->
    <template if:true={showCameraModal}>
        <section role="dialog" class="slds-modal slds-fade-in-open">
            <div class="slds-modal__container camera-modal-container">
                <button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse"
                    onclick={closeCameraModal}>
                    <lightning-icon icon-name="utility:close" alternative-text="Close" size="small"></lightning-icon>
                </button>
                <div class="slds-modal__header">
                    <h2 class="slds-text-heading_medium">Capture Photo</h2>
                </div>
                                <div class="slds-modal__content camera-modal-content">
                    <template if:false={capturedPhoto}>
                        <video class="camera-video" autoplay playsinline></video>
                        <button type="button" class="camera-capture-btn" onclick={handleCapturePhoto}>
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="24" height="24" fill="white">
                                <path d="M149.1 64.8L138.7 96H64C28.7 96 0 124.7 0 160V416c0 35.3 28.7 64 64 64H448c35.3 0 64-28.7 64-64V160c0-35.3-28.7-64-64-64H373.3L362.9 64.8C356.4 45.2 338.1 32 317.4 32H194.6c-20.7 0-39 13.2-45.5 32.8zM256 192a96 96 0 1 1 0 192 96 96 0 1 1 0-192z"/>
                            </svg>
                        </button>
                    </template>
                    <template if:true={capturedPhoto}>
                        <img src={capturedPhoto} alt="Captured" class="captured-preview" />
                        <div class="camera-actions">
                            <button type="button" class="retake-btn" onclick={handleRetakePhoto}>
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="16" height="16" fill="white">
                                    <path d="M463.5 224H472c13.3 0 24-10.7 24-24V72c0-9.7-5.8-18.5-14.8-22.2s-19.3-1.7-26.2 5.2L413.4 96.6c-87.6-86.5-228.7-86.2-315.8 1c-87.5 87.5-87.5 229.3 0 316.8s229.3 87.5 316.8 0c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0c-62.5 62.5-163.8 62.5-226.3 0s-62.5-163.8 0-226.3c62.2-62.2 162.7-62.5 225.3-1L327 183c-6.9 6.9-8.9 17.2-5.2 26.2s12.5 14.8 22.2 14.8H463.5z"/>
                                </svg>
                                Retake
                            </button>
                            <button type="button" class="save-photo-btn" onclick={handleSaveCapturedPhoto}>
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" width="16" height="16" fill="white">
                                    <path d="M64 32C28.7 32 0 60.7 0 96V416c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V173.3c0-17-6.7-33.3-18.7-45.3L352 50.7C340 38.7 323.7 32 306.7 32H64zm0 96c0-17.7 14.3-32 32-32H288c17.7 0 32 14.3 32 32v64c0 17.7-14.3 32-32 32H96c-17.7 0-32-14.3-32-32V128zM224 288a64 64 0 1 1 0 128 64 64 0 1 1 0-128z"/>
                                </svg>
                                Save Photo
                            </button>
                        </div>
                    </template>
                    <canvas class="camera-canvas" style="display: none;"></canvas>
                </div>
            </div>
        </section>
        <div class="slds-backdrop slds-backdrop_open"></div>
    </template>

    <!-- Generic Confirmation Modal -->
    <template if:true={showConfirmationModal}>
        <c-generic-confirmation-modal
            title={confirmationTitle}
            message={confirmationMessage}
            confirm-button-label={confirmationButtonLabel}
            cancel-button-label="Cancel"
            confirm-button-variant={confirmationButtonVariant}
            is-processing={isLoading}
            show-modal={showConfirmationModal}
            size="medium"
            onconfirm={handleConfirmationConfirm}
            oncancel={handleConfirmationCancel}
            onclose={handleConfirmationClose}>
        </c-generic-confirmation-modal>
    </template>
</template>