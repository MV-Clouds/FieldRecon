<template>
    <div class="shift-end-log-container">
        <div class="header-fixed-div">
            <div class="filter-search-container">
                <div class="search-bar">
                    <lightning-input type="search" placeholder="Search by person or date (YYYY-MM-DD)" value={searchTerm} onchange={handleSearch} variant="label-hidden" class="search-bar-input"></lightning-input>
                </div>
                <template if:true={hasAccess}>
                    <div class="right-controls">
                        <div class="create-btn" onclick={handleCreate}>
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" width="14" height="14" fill="white"><path d="M256 80c0-17.7-14.3-32-32-32s-32 14.3-32 32V224H48c-17.7 0-32 14.3-32 32s14.3 32 32 32H192V432c0 17.7 14.3 32 32 32s32-14.3 32-32V288H400c17.7 0 32-14.3 32-32s-14.3-32-32-32H256V80z"/></svg>
                            Create Log
                        </div>
                    </div>
                </template>
            </div>
        </div>
        <div class="spinner-container slds-is-fixed" if:true={isLoading}>
            <lightning-spinner alternative-text="Loading..." size="medium"></lightning-spinner>
        </div>


        <template if:true={hasError}>
            <div class="empty-state">
                <div class="empty-state__content">
                    <div class="empty-state__icon">
                        <img src="/resource/wfrecon__emptyState" alt="" draggable="false">
                    </div>
                    <div class="empty-state__message">{errorMessage}</div>
                </div>
            </div>
        </template>
        <template if:false={isLoading}>
            <template if:false={hasError}>
                <template if:false={hasLogs}>
                    <div class="empty-state">
                        <div class="empty-state__content">
                            <div class="empty-state__icon">
                                <img src="/resource/wfrecon__emptyState" alt="" draggable="false">
                            </div>
                            <div class="empty-state__message">{noLogsMessage}</div>
                        </div>
                    </div>
                </template>
            </template>
        </template>
        
        <template if:true={hasLogs}>
            <div class="logs-grid">
                <template for:each={displayedLogs} for:item="log">
                    <div key={log.Id} class="card-placeholder">
                        <div class={log.cardClass} data-id={log.Id} data-expanded={log.isExpanded}>
                            <div class="log-card-header">

                                <div class="log-card-sub-header">
                                    <div class="log-header-detail">
                                        <div class="log-card-name-status">
                                            <div class="log-card-name" data-id={log.Id}>{log.Name}</div>
                                            <div class="log-card-date">{log.formattedDate}</div>
                                        </div>
                                    </div>
                                    
                                    <template if:true={isCurrentUserCrewLeader}>
                                        <div class="action-btns">
                                            <!-- Only show edit button if log can be edited (not approved) -->
                                            <template if:true={log.canEdit}>
                                                <div class="edit-btn btn action-btn" data-id={log.Id} onclick={handleEdit}>
                                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path d="M416.9 85.2L372 130.1L509.9 268L554.8 223.1C568.4 209.6 576 191.2 576 172C576 152.8 568.4 134.4 554.8 120.9L519.1 85.2C505.6 71.6 487.2 64 468 64C448.8 64 430.4 71.6 416.9 85.2zM338.1 164L122.9 379.1C112.2 389.8 104.4 403.2 100.3 417.8L64.9 545.6C62.6 553.9 64.9 562.9 71.1 569C77.3 575.1 86.2 577.5 94.5 575.2L222.3 539.7C236.9 535.6 250.2 527.9 261 517.1L476 301.9L338.1 164z"/></svg>
                                                </div>
                                            </template>
                                            <!-- Only show delete button if log can be deleted (not approved) -->
                                            <template if:true={log.canDelete}>
                                                <div class="delete-btn btn action-btn" data-id={log.Id} data-name={log.Name} onclick={handleDelete}>
                                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path d="M232.7 69.9L224 96L128 96C110.3 96 96 110.3 96 128C96 145.7 110.3 160 128 160L512 160C529.7 160 544 145.7 544 128C544 110.3 529.7 96 512 96L416 96L407.3 69.9C402.9 56.8 390.7 48 376.9 48L263.1 48C249.3 48 237.1 56.8 232.7 69.9zM512 208L128 208L149.1 531.1C150.7 556.4 171.7 576 197 576L443 576C468.3 576 489.3 556.4 490.9 531.1L512 208z"/></svg>
                                                </div>
                                            </template>
                                        </div>
                                    </template>
                                </div>

                                <div class="log-meta-info">
                                    <div class="log-meta-info-name">
                                        <span class="status-text">{log.status}</span>
                                        <span class="separator">•</span>
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" width="14" height="14"><path d="M224 256A128 128 0 1 0 224 0a128 128 0 1 0 0 256zm-45.7 48C79.8 304 0 383.8 0 482.3C0 498.7 13.3 512 29.7 512H418.3c16.4 0 29.7-13.3 29.7-29.7C448 383.8 368.2 304 269.7 304H178.3z"/></svg>
                                        <span>{log.createdByName}</span>
                                    </div>
                                </div>

                                <!-- View More / View Less Button -->
                                <div class="view-more-container">
                                    <button class="view-more-btn" data-id={log.Id} onclick={handleToggleCard}>
                                        <template if:false={log.isExpanded}>
                                            <span>View More</span>
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" width="12" height="12">
                                                <path d="M201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z"/>
                                            </svg>
                                        </template>
                                        <template if:true={log.isExpanded}>
                                            <span>View Less</span>
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" width="12" height="12">
                                                <path d="M201.4 137.4c12.5-12.5 32.8-12.5 45.3 0l160 160c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L224 205.3 86.6 342.6c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3l160-160z"/>
                                            </svg>
                                        </template>
                                    </button>
                                </div>
                            </div>

                            <div class="log-card-body">
                                <div class="section-label">
                                    Work Performed:
                                    <template if:true={log.workPerformedChanged}>
                                        <span class="changed-today-badge">Modified Today</span>
                                    </template>
                                </div>
                                <div class={log.workPerformedChanged} data-changed={log.workPerformedChanged}>
                                    <div class="work-content" data-is-changed={log.workPerformedChanged}>{log.displayWorkPerformed}</div>
                                </div>
                                
                                <div class="section-label">
                                    Exceptions:
                                    <template if:true={log.exceptionsChanged}>
                                        <span class="changed-today-badge">Modified Today</span>
                                    </template>
                                </div>
                                <div class={log.exceptionsChanged} data-changed={log.exceptionsChanged}>
                                    <div class={log.exceptionContentClass} data-is-changed={log.exceptionsChanged}>{log.displayExceptions}</div>
                                </div>
                                
                                <div class="section-label">
                                    Plan for Tomorrow:
                                    <template if:true={log.planForTomorrowChanged}>
                                        <span class="changed-today-badge">Modified Today</span>
                                    </template>
                                </div>
                                <div class={log.planForTomorrowChanged} data-changed={log.planForTomorrowChanged}>
                                    <div class="plan-content" data-is-changed={log.planForTomorrowChanged}>{log.displayPlanForTomorrow}</div>
                                </div>
                                
                                <div class="section-label">
                                    Notes to Office:
                                    <template if:true={log.notesToOfficeChanged}>
                                        <span class="changed-today-badge">Modified Today</span>
                                    </template>
                                </div>
                                <div class={log.notesToOfficeChanged} data-changed={log.notesToOfficeChanged}>
                                    <div class="plan-content" data-is-changed={log.notesToOfficeChanged}>{log.displayNotesToOffice}</div>
                                </div>
                                
                                <template if:true={isCurrentUserCrewLeader}>
                                    <template if:true={log.hasLocationProcesses}>
                                        <div class="section-label">Location Processes:</div>
                                        <div class="location-processes-accordion">
                                            <template for:each={log.groupedLocationProcesses} for:item="locationGroup" for:index="index">
                                                <div key={locationGroup.sectionName} class="location-accordion-item">
                                                    <div class="location-accordion-header" data-section={locationGroup.sectionName} data-log-id={log.Id} onclick={handleViewAccordionToggle}>
                                                        <span class="location-accordion-title">{locationGroup.locationName}</span>
                                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" width="12" height="12" class="accordion-icon">
                                                            <path d="M201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z"/>
                                                        </svg>
                                                    </div>
                                                    <div class="location-accordion-content" data-section={locationGroup.sectionName} data-log-id={log.Id}>
                                                        <template for:each={locationGroup.processes} for:item="process">
                                                            <div key={process.processId} class="process-item" data-changed={process.changedToday} data-has-approval={process.isPendingApproval}>
                                                                <div class="process-header">
                                                                    <div class="process-percentage-container">
                                                                        <span class="process-percentage">{process.completionPercentage}%</span>
                                                                        <template if:true={process.changedToday}>
                                                                            <span class="process-changed-badge">Updated Today</span>
                                                                        </template>
                                                                    </div>
                                                                </div>
                                                                <div class="process-name-row">
                                                                    <template if:true={process.sequence}>
                                                                        <span class="process-seq">#{process.sequence}</span>
                                                                    </template>
                                                                    <span class="process-name">{process.processName}</span>
                                                                </div>
                                                                
                                                                <div class="process-progress-bar">
                                                                    <div class="process-progress-fill yesterday-progress" 
                                                                         data-percentage={process.yesterdayPercentage}
                                                                         data-color={process.progressBarColor}>
                                                                    </div>
                                                                    <template if:true={process.changedToday}>
                                                                        <div class="process-progress-fill today-progress" 
                                                                             data-percentage={process.completionPercentage}
                                                                             data-yesterday={process.yesterdayPercentage}
                                                                             data-color={process.todayChangeColor}>
                                                                        </div>
                                                                    </template>
                                                                    <template if:true={process.isPendingApproval}>
                                                                        <div class="process-progress-fill approval-progress" 
                                                                             data-percentage={process.approvalNewValue}
                                                                             data-yesterday={process.displayYesterdayPercentage}>
                                                                        </div>
                                                                    </template>
                                                                </div>
                                                            </div>
                                                        </template>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </template>
                                </template>
                                
                                <template if:true={log.hasImages}>
                                    <div class="section-label images-label">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="14" height="14"><path d="M0 96C0 60.7 28.7 32 64 32H448c35.3 0 64 28.7 64 64V416c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V96zM323.8 202.5c-4.5-6.6-11.9-10.5-19.8-10.5s-15.4 3.9-19.8 10.5l-87 127.6L170.7 297c-4.6-5.7-11.5-9-18.7-9s-14.2 3.3-18.7 9l-64 80c-5.8 7.2-6.9 17.1-2.9 25.4s12.4 13.6 21.6 13.6h96 32H424c8.9 0 17.1-4.9 21.2-12.8s3.6-17.4-1.4-24.7l-120-176zM112 192a48 48 0 1 0 0-96 48 48 0 1 0 0 96z"/></svg>
                                        <span style="margin-top: 6px;">Media ({log.imageCount})</span>
                                    </div>
                                    <div class="images-grid">
                                        <template for:each={log.images} for:item="image">
                                            <div key={image.Id} class="image-thumbnail" data-id={image.ContentDocumentId} data-version-id={image.Id} onclick={handleImagePreview}>
                                                <template if:true={image.isImage}>
                                                    <img src={image.thumbnailUrl} alt={image.Title} />
                                                </template>
                                                <template if:false={image.isImage}>
                                                    <div class="file-preview-placeholder">
                                                        <lightning-icon icon-name={image.fileIcon} size="large"></lightning-icon>
                                                        <div class="file-ext-label">{image.FileExtension}</div>
                                                        <div class="file-name-label">{image.Title}</div>
                                                    </div>
                                                </template>
                                            </div>
                                        </template>
                                    </div>
                                </template>
                            </div>
                            
                            
                        </div>
                    </div>

                </template>
            </div>
        </template>

        <template if:true={hasLogs}>
            <!-- Pagination Section -->
            <div class="pagination-section">
                <div class="pagination-container">
                    <button 
                        class="pagination-button" 
                        onclick={handlePrevious} 
                        disabled={isFirstPage}>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Previous
                    </button>
                    
                    <template for:each={pageNumbers} for:item="page">
                        <template if:false={page.isEllipsis}>
                            <button 
                                key={page.number}
                                class={page.cssClass}
                                data-page={page.number}
                                onclick={handlePageChange}>
                                {page.number}
                            </button>
                        </template>
                        <template if:true={page.isEllipsis}>
                            <span key={page.number} class="pagination-ellipsis">...</span>
                        </template>
                    </template>
                    
                    <button 
                        class="pagination-button" 
                        onclick={handleNext} 
                        disabled={isLastPage}>
                        Next
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
            </div>
        </template>
    </div>

    <!-- Edit Modal Popup -->
    <template if:true={showEditModal}>
        <section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open shift-end-edit-modal">
            <div class="slds-modal__container edit-modal">
                <!-- Modal header -->
                <header class="slds-modal__header edit-modal-header">
                    <button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse" 
                            title="Close" 
                            onclick={handleCloseModal}>
                        <lightning-icon icon-name="utility:close" size="small" alternative-text="close"
                                        class="slds-button__icon slds-button__icon_large"></lightning-icon>
                        <span class="slds-assistive-text">Close</span>
                    </button>
                    <h2 class="slds-text-heading_medium">Edit Shift End Log</h2>
                </header>

                <!-- Progress Indicator -->
                <div class="edit-progress-container">
                    <lightning-progress-indicator current-step={editCurrentStep} type="path" variant="base">
                        <lightning-progress-step label="Log Details" value="step1"></lightning-progress-step>
                        <lightning-progress-step label="Location Progress" value="step2"></lightning-progress-step>
                        <lightning-progress-step label="Gallery" value="step3"></lightning-progress-step>
                    </lightning-progress-indicator>
                </div>

                <!-- Modal content -->
                <div class="slds-modal__content edit-modal-body">
                    
                    <!-- Step 1: Log Details -->
                    <template if:true={isEditStep1}>
                        <div class="edit-step-container">
                            <form onsubmit={handleSaveEdit}>
                                <!-- Work Performed Date Field -->
                                <div class="slds-m-bottom_medium work-performed-date">
                                    <lightning-input
                                        type="date"
                                        label="Work Performed Date"
                                        value={editFormData.workPerformedDate}
                                        data-field="workPerformedDate"
                                        onchange={handleEditInputChange}
                                        required>
                                    </lightning-input>
                                </div>

                                <!-- Work Performed Field -->
                                <div class="slds-m-bottom_medium">
                                    <lightning-textarea
                                        label="Work Performed"
                                        value={editFormData.workPerformed}
                                        data-field="workPerformed"
                                        onchange={handleEditInputChange}
                                        placeholder="Enter work performed details..."
                                        max-length="32000"
                                        required>
                                    </lightning-textarea>
                                </div>

                                <!-- Plan for Tomorrow Field -->
                                <div class="slds-m-bottom_medium">
                                    <lightning-textarea
                                        label="Plan for Tomorrow"
                                        data-field="planForTomorrow"
                                        value={editFormData.planForTomorrow}
                                        onchange={handleEditInputChange}
                                        placeholder="Enter plan for tomorrow..."
                                        max-length="32000"
                                        required>
                                    </lightning-textarea>
                                </div>

                                <!-- Exceptions Field (Optional) -->
                                <div class="slds-m-bottom_medium">
                                    <lightning-textarea
                                        label="Exceptions"
                                        value={editFormData.exceptions}
                                        data-field="exceptions"
                                        onchange={handleEditInputChange}
                                        placeholder="Enter any exceptions (Optional)..."
                                        max-length="32000">
                                    </lightning-textarea>
                                </div>

                                <!-- Notes to Office Field (Optional) -->
                                <div class="slds-m-bottom_medium">
                                    <lightning-textarea
                                        label="Notes to Office"
                                        data-field="notesToOffice"
                                        value={editFormData.notesToOffice}
                                        onchange={handleEditInputChange}
                                        placeholder="Enter notes to office..."
                                        max-length="32000">
                                    </lightning-textarea>
                                </div>
                            </form>
                        </div>
                    </template>

                    <!-- Step 2: Location Progress -->
                    <template if:true={isEditStep2}>
                        <div class="edit-step-container">
                            <div class="edit-location-progress-section">
                                <!-- Location Accordion -->
                                <template if:true={hasEditLocationOptions}>
                                    <div class="edit-location-accordion">
                                        <template for:each={editGroupedLocationProcesses} for:item="locationGroup" for:index="index">
                                            <div key={locationGroup.sectionName} class="edit-location-accordion-item">
                                                <div class="edit-location-accordion-header" data-section={locationGroup.sectionName} onclick={handleEditViewAccordionToggle}>
                                                    <span class="edit-location-accordion-title">{locationGroup.locationName}</span>
                                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" width="12" height="12" class="edit-accordion-icon">
                                                        <path d="M201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z"/>
                                                    </svg>
                                                </div>
                                                <div class="edit-location-accordion-content" data-section={locationGroup.sectionName}>
                                                    <template for:each={locationGroup.processes} for:item="process">
                                            <div key={process.processId} class="edit-location-slider-container" data-changed={process.changedToday} data-has-approval={process.isPendingApproval}>
                                                <div class="slider-header">
                                                    <div class="process-info">
                                                        <span class="process-name">{process.processName}</span>
                                                        <template if:true={process.sequence}>
                                                            <span class="process-sequence">Seq: {process.sequence}</span>
                                                        </template>
                                                    </div>
                                                    <span class="progress-percentage">{process.completionPercentage}% Complete</span>
                                                </div>
                                                <!-- Pending Approval Info in Edit Modal -->
                                                <template if:true={process.isPendingApproval}>
                                                    <div class="process-approval-info-modal">
                                                        <div class="approval-header-with-reset">
                                                            <div class="approval-badge-modal">
                                                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="12" height="12" fill="currentColor">
                                                                    <path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM216 336h24V272H216c-13.3 0-24-10.7-24-24s10.7-24 24-24h48c13.3 0 24 10.7 24 24v88h8c13.3 0 24 10.7 24 24s-10.7 24-24 24H216c-13.3 0-24-10.7-24-24s10.7-24 24-24zm40-208a32 32 0 1 1 0 64 32 32 0 1 1 0-64z"/>
                                                                </svg>
                                                                <span>Approval Requested</span>
                                                            </div>
                                                            <button 
                                                                type="button" 
                                                                class="reset-approval-btn" 
                                                                data-process-id={process.processId}
                                                                onclick={handleResetApproval}
                                                                title="Reset to original base value">
                                                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="12" height="12" fill="currentColor">
                                                                    <path d="M463.5 224H472c13.3 0 24-10.7 24-24V72c0-9.7-5.8-18.5-14.8-22.2s-19.3-1.7-26.2 5.2L413.4 96.6c-87.6-86.5-228.7-86.2-315.8 1c-87.5 87.5-87.5 229.3 0 316.8s229.3 87.5 316.8 0c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0c-62.5 62.5-163.8 62.5-226.3 0s-62.5-163.8 0-226.3c62.2-62.2 162.7-62.5 225.3-1L327 183c-6.9 6.9-8.9 17.2-5.2 26.2s12.5 14.8 22.2 14.8H463.5z"/>
                                                                </svg>
                                                                Reset
                                                            </button>
                                                        </div>
                                                        <div class="approval-details-modal">
                                                            <span class="detail-label">Base: <strong>{process.yesterdayPercentage}%</strong></span>
                                                            <span class="approval-arrow">→</span>
                                                            <span class="detail-label highlight">Sent for Approval: <strong>{process.approvalNewValue}%</strong></span>
                                                        </div>
                                                    </div>
                                                </template>
                                                
                                                <div class="slider-wrapper">
                                                    <div class="slider-track">
                                                        <div class="slider-section completed" lwc:dom="manual"></div>
                                                        <div class="slider-section approval" lwc:dom="manual" style="display: none;"></div>
                                                        <div class="slider-section today" lwc:dom="manual"></div>
                                                        <div class="slider-section remaining" lwc:dom="manual"></div>
                                                    </div>
                                                    <input 
                                                        type="range" 
                                                        min={process.sliderMinValue} 
                                                        max="100" 
                                                        step="1"
                                                        value={process.completionPercentage}
                                                        data-process-id={process.processId}
                                                        data-original-value={process.sliderMinValue}
                                                        class="progress-slider"
                                                        oninput={handleEditSliderInput}
                                                        onchange={handleEditSliderChange} />
                                                </div>
                                                <div class="slider-labels">
                                                    <span class="label-completed">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                                            <circle cx="12" cy="12" r="10" />
                                                        </svg>
                                                        Previous Completed: {process.yesterdayPercentage}%
                                                    </span>
                                                    <span class="label-today">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                                            <circle cx="12" cy="12" r="10" />
                                                        </svg>
                                                        Today: {process.todayProgress}%
                                                    </span>
                                                    <span class="label-remaining">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                                            <circle cx="12" cy="12" r="10" />
                                                        </svg>
                                                        Remaining: {process.remainingProgress}%
                                                    </span>
                                                </div>
                                            </div>
                                                    </template>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </template>

                                <template if:false={hasEditLocationOptions}>
                                    <div class="no-data-message">
                                        <div class="no-data-icon">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor">
                                                <path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zm0-384c13.3 0 24 10.7 24 24V264c0 13.3-10.7 24-24 24s-24-10.7-24-24V152c0-13.3 10.7-24 24-24zM224 352a32 32 0 1 1 64 0 32 32 0 1 1 -64 0z"/>
                                            </svg>
                                        </div>
                                        <div class="no-data-title">No Location Processes</div>
                                        <div class="no-data-description">No location processes available for this job.</div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>

                    <!-- Step 3: Images -->
                    <template if:true={isEditStep3}>
                        <div class="edit-step-container">
                            <!-- Image Gallery Section -->
                            <div class="slds-m-bottom_medium gallery-section">
                                
                                <!-- Upload Buttons -->
                                <div class="upload-actions">
                                    <div class="upload-buttons-container">
                                        <!-- Upload New Files with Standard Lightning Component -->
                                        <div class="upload-button-wrapper">
                                            <lightning-file-upload 
                                                accept={acceptedFormats} 
                                                multiple
                                                record-id={editLogId} 
                                                onuploadfinished={handleUploadFinished}
                                                variant="label-hidden">
                                            </lightning-file-upload>
                                        </div>
                                        
                                        <!-- Choose from Chatter Button -->
                                        <button type="button" class="nav-btn done-btn gallery-btn" onclick={handleChooseFromChatter}>
                                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                            </svg>
                                            Choose from Chatter
                                        </button>
                                        
                                        <!-- Camera Option - Only for Desktop -->
                                        <template if:true={isDesktopDevice}>
                                            <button type="button" class="nav-btn done-btn gallery-btn" onclick={handleOpenCamera}>
                                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 512 512" fill="currentColor">
                                                    <path d="M149.1 64.8L138.7 96H64C28.7 96 0 124.7 0 160V416c0 35.3 28.7 64 64 64H448c35.3 0 64-28.7 64-64V160c0-35.3-28.7-64-64-64H373.3L362.9 64.8C356.4 45.2 338.1 32 317.4 32H194.6c-20.7 0-39 13.2-45.5 32.8zM256 192a96 96 0 1 1 0 192 96 96 0 1 1 0-192z" />
                                                </svg>
                                                Capture Photo
                                            </button>
                                        </template>
                                    </div>
                                </div>                            
                                <!-- Image Display Grid -->
                                <template if:true={hasImages}>
                                    <div class="photo-grid">
                                        <template for:each={allImages} for:item="image">
                                            <div key={image.id} class="photo-item">
                                                <template if:true={image.isImage}>
                                                    <img src={image.url} 
                                                         alt={image.name} 
                                                         class="photo-thumbnail" 
                                                         loading="lazy"
                                                         data-id={image.id}
                                                         data-version-id={image.versionId}
                                                         onclick={handleModalImagePreview} />
                                                </template>
                                                <template if:false={image.isImage}>
                                                    <div class="file-preview-placeholder modal-file-preview"
                                                         data-id={image.id}
                                                         data-version-id={image.versionId}
                                                         onclick={handleModalImagePreview}>
                                                        <lightning-icon icon-name={image.fileIcon} size="large"></lightning-icon>
                                                        <div class="file-ext-label">{image.extension}</div>
                                                        <div class="file-name-label">{image.name}</div>
                                                    </div>
                                                </template>
                                                <button 
                                                    class="remove-photo-btn" 
                                                    data-id={image.id}
                                                    data-existing={image.isExisting}
                                                    data-camera={image.isCamera}
                                                    data-chatter={image.isChatter}
                                                    onclick={handleRemoveImage}
                                                    title="Remove file">
                                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" width="12" height="12" fill="white">
                                                        <path d="M342.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L192 210.7 86.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L146.7 256 41.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L192 301.3 297.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L237.3 256 342.6 150.6z"/>
                                                    </svg>
                                                </button>
                                                <div class="photo-name">{image.name}</div>
                                            </div>
                                        </template>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>
                
                <!-- Control buttons - Sticky Footer -->
                <div class="bottom-footer-btn">
                    <!-- Previous Button - Always visible, disabled on step 1 -->
                    <button class="nav-btn prev-btn" type="button" onclick={handleEditPrevious} disabled={isEditStep1}>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <polyline points="15 18 9 12 15 6"></polyline>
                        </svg>
                        Previous
                    </button>
                    
                    <div class="spacer"></div>
                    
                    <!-- Next Button -->
                    <template if:false={isEditStep3}>
                        <button class="nav-btn next-btn" type="button" onclick={handleEditNext}>
                            Next
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                        </button>
                    </template>
                    
                    <!-- Update Button (only on last step) -->
                    <template if:true={isEditStep3}>
                        <button class="nav-btn save-btn" type="button" onclick={handleSaveEdit} disabled={isLoading}>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                            Update
                        </button>
                    </template>
                </div>
            </div>
        </section>
        <!-- Modal Backdrop -->
        <div class="slds-backdrop slds-backdrop_open edit-backdrop"></div>
    </template>

    <template if:true={showEntryPopup}>
        <c-shift-end-log-entries onclose={handleCloseEntryPopup} job-id={recordId} crew-leader-id={crewLeaderId} crew-ids={crewIds} ></c-shift-end-log-entries>
    </template>

    <!-- Camera Modal -->
    <template if:true={showCameraModal}>
        <section role="dialog" class="slds-modal slds-fade-in-open">
            <div class="slds-modal__container camera-modal-container">
                <button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse"
                    onclick={closeCameraModal}>
                    <lightning-icon icon-name="utility:close" alternative-text="Close" size="small"></lightning-icon>
                </button>
                
                <header class="slds-modal__header edit-modal-header">
                    <h2 class="slds-text-heading_medium">Capture Photo</h2>
                </header>
                
                <div class="slds-modal__content camera-modal-content">
                    <template if:false={capturedPhoto}>
                        <video class="camera-video" autoplay playsinline></video>
                        <button type="button" class="camera-capture-btn" onclick={handleCapturePhoto}>
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="24" height="24" fill="white">
                                <path d="M149.1 64.8L138.7 96H64C28.7 96 0 124.7 0 160V416c0 35.3 28.7 64 64 64H448c35.3 0 64-28.7 64-64V160c0-35.3-28.7-64-64-64H373.3L362.9 64.8C356.4 45.2 338.1 32 317.4 32H194.6c-20.7 0-39 13.2-45.5 32.8zM256 192a96 96 0 1 1 0 192 96 96 0 1 1 0-192z"/>
                            </svg>
                        </button>
                    </template>
                    <template if:true={capturedPhoto}>
                        <img src={capturedPhoto} alt="Captured" class="captured-preview" />
                        <div class="camera-actions">
                            <button type="button" class="retake-btn" onclick={handleRetakePhoto}>
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="16" height="16" fill="white">
                                    <path d="M463.5 224H472c13.3 0 24-10.7 24-24V72c0-9.7-5.8-18.5-14.8-22.2s-19.3-1.7-26.2 5.2L413.4 96.6c-87.6-86.5-228.7-86.2-315.8 1c-87.5 87.5-87.5 229.3 0 316.8s229.3 87.5 316.8 0c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0c-62.5 62.5-163.8 62.5-226.3 0s-62.5-163.8 0-226.3c62.2-62.2 162.7-62.5 225.3-1L327 183c-6.9 6.9-8.9 17.2-5.2 26.2s12.5 14.8 22.2 14.8H463.5z"/>
                                </svg>
                                Retake
                            </button>
                            <button type="button" class="save-photo-btn" onclick={handleSaveCapturedPhoto}>
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" width="16" height="16" fill="white">
                                    <path d="M64 32C28.7 32 0 60.7 0 96V416c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V173.3c0-17-6.7-33.3-18.7-45.3L352 50.7C340 38.7 323.7 32 306.7 32H64zm0 96c0-17.7 14.3-32 32-32H288c17.7 0 32 14.3 32 32v64c0 17.7-14.3 32-32 32H96c-17.7 0-32-14.3-32-32V128zM224 288a64 64 0 1 1 0 128 64 64 0 1 1 0-128z"/>
                                </svg>
                                Save Photo
                            </button>
                        </div>
                    </template>
                    <canvas class="camera-canvas" style="display: none;"></canvas>
                </div>
            </div>
        </section>
        <div class="slds-backdrop slds-backdrop_open sub-backdrop"></div>
    </template>

    <!-- Chatter Feed Modal -->
    <template if:true={showChatterModal}>
        <section role="dialog" class="slds-modal slds-fade-in-open sub-modal">
            <div class="slds-modal__container chatter-modal-container">
                
                <button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse"
                    onclick={closeChatterModal}>
                    <lightning-icon icon-name="utility:close" alternative-text="Close" class="close-icon"
                        size="small"></lightning-icon>
                </button>
                
                <header class="slds-modal__header edit-modal-header">
                    <h2 class="slds-text-heading_medium">Choose from Chatter</h2>
                </header>
                
                <div class="slds-modal__content camera-modal-content">
                    <template if:true={isLoadingChatter}>
                        <div class="chatter-loading">
                            <lightning-spinner alternative-text="Loading..." size="small"></lightning-spinner>
                        </div>
                    </template>
                    
                    <template if:false={isLoadingChatter}>
                        <!-- No Feed Items Message -->
                        <template if:false={hasChatterFeedItems}>
                            <div class="no-data-message-chatter">
                                <div class="no-data-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                    </svg>
                                </div>
                                <h3 class="no-data-title">No Chatter Posts</h3>
                                <p class="no-data-description">
                                    <template if:true={hasMoreChatterItems}>No posts found in the current time range.</template>
                                    <template if:false={hasMoreChatterItems}>No posts with attachments found for this job.</template>
                                </p>
                            </div>
                        </template>
                        
                        <!-- Feed Items List -->
                        <template if:true={hasChatterFeedItems}>
                            <div class="chatter-feed-list">
                                <template for:each={chatterFeedItems} for:item="feedItem">
                                    <div key={feedItem.id} class="chatter-feed-item">
                                        <div class="feed-item-header">
                                            <div class="feed-item-date">{feedItem.formattedDate}</div>
                                        </div>
                                        <div class="feed-item-attachments">
                                            <template for:each={feedItem.attachments} for:item="attachment">
                                                <div key={attachment.id} class={attachment.cardClass} data-id={attachment.id} onclick={handleAttachmentSelection}>
                                                    <template if:true={attachment.selected}>
                                                        <div class="attachment-selected-badge">
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="white">
                                                                <polyline points="20 6 9 17 4 12" stroke="white" stroke-width="2" fill="none"></polyline>
                                                            </svg>
                                                        </div>
                                                    </template>
                                                    <template if:true={attachment.alreadyUploaded}>
                                                        <div class="attachment-uploaded-badge">
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="white">
                                                                <polyline points="20 6 9 17 4 12" stroke="white" stroke-width="2" fill="none"></polyline>
                                                            </svg>
                                                            Already Added
                                                        </div>
                                                    </template>
                                                    <template if:true={attachment.isImage}>
                                                        <img src={attachment.thumbnailUrl} alt={attachment.title} class="attachment-thumbnail">
                                                    </template>
                                                    <template if:false={attachment.isImage}>
                                                        <div class="attachment-file-icon">
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                                                <polyline points="14 2 14 8 20 8"></polyline>
                                                            </svg>
                                                        </div>
                                                    </template>
                                                    <div class="attachment-title">{attachment.title}</div>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </template>

                        <!-- Load More Button -->
                        <template if:true={hasMoreChatterItems}>
                            <div class="load-more-container">
                                <button type="button" class="load-more-btn" onclick={handleLoadMoreChatter} disabled={isLoadingMoreChatter}>
                                    <template if:true={isLoadingMoreChatter}>Loading...</template>
                                    <template if:false={isLoadingMoreChatter}>Load More</template>
                                </button>
                            </div>
                        </template>
                    </template>
                </div>
                <div class="bottom-footer-btn">
                    <button class="retake-btn" onclick={closeChatterModal}>Cancel</button>
                    <button class="save-btn nav-btn slds-m-left--medium" onclick={handleAddSelectedAttachments} disabled={hasNoSelectedAttachments}>Add Selected</button>
                </div>
            </div>
        </section>
        <div class="slds-backdrop slds-backdrop_open sub-backdrop"></div>
    </template>

    <!-- Generic Confirmation Modal -->
    <template if:true={showConfirmationModal}>
        <c-generic-confirmation-modal
            title={confirmationTitle}
            message={confirmationMessage}
            confirm-button-label={confirmationButtonLabel}
            cancel-button-label="Cancel"
            confirm-button-variant={confirmationButtonVariant}
            is-processing={isLoading}
            show-modal={showConfirmationModal}
            size="medium"
            onconfirm={handleConfirmationConfirm}
            oncancel={handleConfirmationCancel}
            onclose={handleConfirmationClose}>
        </c-generic-confirmation-modal>
    </template>
</template>