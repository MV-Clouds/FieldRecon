<!--
  @description       : 
  @author            : ChangeMeIn@UserSettingsUnder.SFDoc
  @group             : 
  @last modified on  : 02-18-2022
  @last modified by  : ChangeMeIn@UserSettingsUnder.SFDoc
  Modifications Log 
  Ver   Date         Author                               Modification
  1.0   03-31-2021   ChangeMeIn@UserSettingsUnder.SFDoc   Initial Version
-->
<template>
  <div class="container slds-var-p-around_x-small">
    <!-- Filters -->
    <lightning-layout
      class="slds-var-m-horizontal_xxx-small slds-var-m-bottom_small slds-wrap"
      flexibility="auto"
      horizontal-align="space"
      vertical-align="end"
      multiple-rows="true"
    >
      <!-- Group by filter -->
      <lightning-layout-item
        size="12"
        medium-device-size="2"
        class="slds-var-p-around_x-small"
      >
        <lightning-combobox
          label="Group By"
          value={dateSelected}
          placeholder="Select Date Range"
          options={dateOptions}
          onchange={handleDateRangeChange}
        ></lightning-combobox>
      </lightning-layout-item>
      <!-- /Group by filter -->

      <!-- Start / End date inputs -->
      <template if:true={showDateRangeFields}>
        <lightning-layout-item
          size="6"
          medium-device-size="2"
          class="slds-var-p-around_x-small"
        >
          <lightning-input
            label="Start Date"
            type="date"
            variant="standard"
            onchange={startDatehandleChange}
          ></lightning-input>
        </lightning-layout-item>
        <lightning-layout-item
          size="6"
          medium-device-size="2"
          class="slds-var-p-around_x-small"
        >
          <lightning-input
            label="End Date"
            type="date"
            variant="standard"
            onchange={endDatehandleChange}
          ></lightning-input>
        </lightning-layout-item>
      </template>
      <!-- /Start / End date inputs -->

      <!-- Filter by Employee -->
      <lightning-layout-item
        size="12"
        medium-device-size="2"
        class="slds-var-p-around_x-small"
      >
        <c-custom-look-up
          object-a-p-i-name="Contact"
          soql-filter="TimeSheetReport_UserSOQLFilter"
          icon-name="standard:contact"
          placeholder="All"
          label="Filter by Employee"
          onlookupchanged={onUserFilterChanged}
        ></c-custom-look-up>
      </lightning-layout-item>
      <!-- /Filter by Employee -->

      <!-- Filter by Cost Codes -->
      <template if:true={costCodeAccess}>
        <lightning-layout-item
        size="12"
        medium-device-size="2"
        class="slds-var-p-around_x-small"
      >
        <c-custom-look-up
          object-a-p-i-name="Cost_Code__c"
          label="Filter by Cost Codes"
          placeholder="All"
          icon-name="standard:article"
          onlookupchanged={onCostCodesFilterChanged}
        ></c-custom-look-up>
      </lightning-layout-item>
      </template>
      <!-- /Filter by Cost Codes -->

      <!-- Filter by Job Status -->
      <lightning-layout-item
        size="12"
        medium-device-size="2"
        class="slds-var-p-around_x-small"
      >
        <lightning-combobox
          name="status"
          label="Filter by Job Status"
          value={selectedJobStatus}
          placeholder="Select Status"
          options={jobStatusOptions}
          onchange={onJobStatusChanged}
        ></lightning-combobox>
      </lightning-layout-item>
      <!-- /Filter by Job Status -->

      <!-- Download as CSV -->
      <lightning-layout-item
        size="12"
        medium-device-size="2"
        class="slds-var-p-around_x-small"
      >
        <lightning-button
          variant="brand-outline"
          label="Download"
          title="Download (CSV)"
          onclick={onDownload}
          icon-name="utility:download"
        >
        </lightning-button>
      </lightning-layout-item>
      <!-- /Download as CSV -->
      
      <template if:true={formFactor}>
        <lightning-layout-item class="slds-var-p-around_x-small">
      <lightning-button
          variant="brand-outline"
          label="Generate PDF"
          title="Download pdf"
          onclick={generatePdf}
          icon-name="doctype:pdf"
        ></lightning-button>
      </lightning-layout-item>

      </template>
      
    </lightning-layout>
    <!-- /Filters -->

    <template if:true={isLoading} >
      <lightning-spinner
        size="x-small"
        alternative-text="Loading..."
        style = "position: fixed !important;"
      ></lightning-spinner>
      </template>
    <!-- Time entries of members -->
    <div class = "section-to-print">
    <div class="slds-is-relative">
      <template for:each={timesheetsToDisplay} for:item="ts">
        <!-- Display timesheet data in a single card (Daily/Weekly/Monthly/Custom) -->
        <div key={ts.title} class="slds-var-m-vertical_small slds-scrollable">
          <lightning-card title={ts.title} variant="base">
            <!-- Display timesheet data -->
            <table class="slds-table">
              <thead>
                <tr class="slds-line-height_reset">
                  <th class="" scope="col">
                    <div class="slds-truncate" title="Member Name">Member Names</div>
                  </th> 
                  <th class="" scope="col">
                    <div class="slds-truncate" title="Job Name">Job Name</div>
                  </th> 
                  <th class="" scope="col">
                    <div class="slds-truncate" title="Time Log(HR)">Time Log(HR) </div>
                  </th>
                  <template if:true={costCodeAccess}>
                    <th class="" scope="col">
                      <div class="slds-truncate" title="Cost Code">Cost Code </div>
                    </th>
                  </template> 
                </tr>
              </thead>
              <tbody>
                  <template for:each={ts.data} for:item="tse">
                    <tr key={tse.id} class="slds-hint-parent">
                      <td data-label="Member Name">
                        <div class={tse.open}>
                          <h3 class="slds-section__title">
                              <button class="slds-button slds-section__title-action tableButton"  data-id={tse.id} onclick={handleClick}>
                                  <lightning-icon
                                      data-id={tse.id}
                                      icon-name="utility:switch"
                                      class="slds-button__icon slds-button__icon_left slds-section__title-action-icon"
                                      size="x-small"
                                  ></lightning-icon>
                                  <span class="slds-truncate" data-id={tse.id} >{tse.memberName}</span>
                              </button>
                          </h3>
                        </div>
                      
                        <!-- -->
                      </td>
                      <td data-label="Job Name">
                        <template if:true={tse.hasJobName}>
                          <a href={tse.jobLink} target="_self">
                            {tse.jobName}
                          </a>
                        </template>
                        <template if:false={tse.hasJobName}>
                          <a href={tse.jobLink} target="_self">
                            {tse.jobAutoName}
                          </a>
                        </template>
                      </td>
                      <td data-label="Time Log(HR)">{tse.timeLog}</td>
                      <template if:true={costCodeAccess}>
                        <td data-label="Cost Code">{tse.costCode}</td>
                      </template>
                    </tr>
                    <template if:true={tse.expanded}>
                    <tr key={tse.id}>
                      <td colspan="4">
                          <template for:each={selectedEmployeeTimeLogs} for:item="timeLog">
                            <div key={timeLog.title} class="slds-var-m-vertical_small">
                              <lightning-card title={timeLog.title}>
                                <lightning-datatable
                                  data-id="datatable"
                                  columns={employeeTimeLogColumns}
                                  key-field="id"
                                  data={timeLog.entries}
                                  hide-checkbox-column="true"
                                  onrowaction={handleRowAction}
                                  class="slds-table_bordered "
                                ></lightning-datatable>
                              </lightning-card>
                            </div>
                            <lightning-layout key={timeLog.title}
                                  horizontal-align="end"
                                  class="slds-var-p-around_small"
                                >
                                <lightning-layout-item>
                                <span class="slds-text-title_caps"
                                >Total Time Logged &nbsp;|&nbsp;
                                </span>
                                <span class="slds-text-title_bold">{timeLog.totalTime} HRS</span>
                              </lightning-layout-item>
                          </lightning-layout>
                          </template>
                      </td>
                    </tr>
                  </template>
                  </template>
              </tbody>
            </table>
            <!-- /Display timesheet data -->
          </lightning-card>
          <lightning-layout
            horizontal-align="end"
            class="slds-var-p-around_small"
          >
            <lightning-layout-item>
              <span class="slds-text-title_caps"
                >Total Time Logged &nbsp;|&nbsp;
              </span>
              <span class="slds-text-title_bold">{ts.totalTime} HRS</span>
            </lightning-layout-item>
          </lightning-layout>
        </div>
        <!-- /Display timesheet data in a single card (Daily/Weekly/Monthly/Custom) -->
      </template>
    </div>
    <!-- /Time entries of members -->

    <!-- Pagination -->
    <template if:true={hasDataToDisplay}>
      <c-custom-paginator
        all-record-ids={timesheetDataIds}
        current-page={currentPage}
        onpagechanged={onPageChanged}
      ></c-custom-paginator>
    </template>
    </div>
    <template if:false={hasDataToDisplay}>
      <div
        class="slds-align_absolute-center slds-text-heading_medium slds-text-color_weak slds-var-p-around_medium"
        style = "height: 50vh;"
      >
        It's empty in here!
      </div>
    </template>
    <!-- /Pagination -->
    <c-modal show-modal={showEditRecordForm} onclosedialog={onEditRecordClose} >
      <span slot="header">Edit Time Entry</span>
      <!-- Spinner -->
      <template if:true={isModalLoading}>
        <lightning-spinner
          size="x-small"
          alternative-text="Loading..."
        ></lightning-spinner>
      </template>
      <lightning-record-edit-form 
      record-id={clickedRecord}
      object-api-name={namespaceObj.namespaceObject}
      onsuccess={handleSuccess}
      onload={handleLoad}>
      <lightning-messages></lightning-messages>
      <lightning-output-field field-name="Name"></lightning-output-field>
      <lightning-input-field field-name={namespaceObj.namespaceClockInField}></lightning-input-field>
      <lightning-input-field field-name={namespaceObj.namespaceClockOutField}></lightning-input-field>
      <lightning-button type="submit" label="Save" variant="brand" onclick={handleUpdateTime}></lightning-button>
      </lightning-record-edit-form>
    </c-modal>
  </div>
</template>