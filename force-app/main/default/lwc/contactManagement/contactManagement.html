<template>
    <template if:true={isLoading}>
        <div class="spinner-container slds-is-fixed">
            <lightning-spinner alternative-text="Loading" size="medium"></lightning-spinner>
        </div>
    </template>

    <div class="main-card">
        <div class="filter-search-container">
            <div class="search-bar">
                <lightning-input type="search" variant="label-hidden"
                    placeholder="Search by Contact Name, Email or Type..." value={searchTerm} onchange={handleSearch}
                    class="search-bar-input">
                </lightning-input>
            </div>

            <div class="right-controls">
                <div class="action-buttons">
                    <button class="action-button" onclick={handleOpenConfig}>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                        </svg>
                        Configure Settings
                    </button>
                    <button class="action-button create-button" onclick={handleCreateNew}>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <line x1="12" y1="5" x2="12" y2="19" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                            <line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        </svg>
                        Create New Contact
                    </button>
                </div>
            </div>
        </div>

        <div class="data-table-container">
            <template if:true={isDataAvailable}>
                <table class="custom-data-table">
                    <thead class="table-header">
                        <tr>
                            <template for:each={contactTableColumns} for:item="col">
                                <th key={col.fieldName} class={col.headerClass} data-field={col.fieldName} onclick={handleSortClick}>
                                    <template if:true={col.sortable}>
                                        <div class="sort-header-content">
                                            <span class="column-label">{col.label}</span>
                                            <div class="sort-icon" data-field={col.fieldName}>
                                                <svg width="16" height="16" viewBox="0 0 384 512" xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M374.6 246.6C368.4 252.9 360.2 256 352 256s-16.38-3.125-22.62-9.375L224 141.3V448c0 17.69-14.33 31.1-31.1 31.1S160 465.7 160 448V141.3L54.63 246.6c-12.5 12.5-32.75 12.5-45.25 0s-12.5-32.75 0-45.25l160-160c12.5-12.5 32.75-12.5 45.25 0l160 160C387.1 213.9 387.1 234.1 374.6 246.6z" />
                                                </svg>
                                            </div>
                                        </div>
                                    </template>
                                    <template if:false={col.sortable}>
                                        <div class="header-content">
                                            <span class="column-label">{col.label}</span>
                                        </div>
                                    </template>
                                </th>
                            </template>
                        </tr>
                    </thead>
                    <tbody class="table-body">
                        <template for:each={displayedContacts} for:item="contactRecord">
                            <tr key={contactRecord.Id}>
                                <template for:each={contactRecord.columns} for:item="col">
                                    <td key={col.key}>
                                        <template if:true={col.isSerialNumber}>
                                            <div class="center-trancate-text">{col.value}</div>
                                        </template>
                                        <template if:true={col.isActions}>
                                            <div class="contact-action-button-container">
                                                <button class="contact-edit-icon-btn" title="Preview" data-record-id={contactRecord.Id} onclick={handlePreviewContact}>
                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                                                </button>
                                                <button class="contact-edit-icon-btn" title="Edit" data-record-id={contactRecord.Id} onclick={handleEditContact}>
                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                                                </button>
                                                <button class="contact-delete-icon-btn" title="Delete" data-record-id={contactRecord.Id} onclick={handleDeleteContact}>
                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                                </button>
                                            </div>
                                        </template>
                                        <template if:true={col.isRegularField}>
                                            <div class="center-trancate-text" title={col.value}>{col.value}</div>
                                        </template>
                                        <template if:true={col.isCheckboxField}>
                                            <div class="center-trancate-text">{col.displayValue}</div>
                                        </template>
                                    </td>
                                </template>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </template>
            <template if:false={isDataAvailable}>
                <div class="no-prop">
                    <div class="empty-state">
                        <div class="empty-state__message">No contact data available to show</div>
                    </div>
                </div>
            </template>
        </div>

        <!-- Pagination Section -->
        <template if:true={isDataAvailable}>
            <div class="pagination-section">
                <div class="pagination-container">
                    <button 
                        class="pagination-button" 
                        onclick={handlePrevious} 
                        disabled={isFirstPage}>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Previous
                    </button>

                    <template for:each={pageNumbers} for:item="page">
                        <template if:false={page.isEllipsis}>
                            <button 
                                key={page.number}
                                class={page.cssClass}
                                data-page={page.number}
                                onclick={handlePageChange}>
                                {page.number}
                            </button>
                        </template>
                        <template if:true={page.isEllipsis}>
                            <span key={page.number} class="pagination-ellipsis">...</span>
                        </template>
                    </template>

                    <button 
                        class="pagination-button" 
                        onclick={handleNext} 
                        disabled={isLastPage}>
                        Next
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
            </div>
        </template>
    </div>

    <!-- <template if:true={showCreateModal}>
        <section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open">
            <div class="slds-modal__container contact-popup">
                <header class="slds-modal__header contact-popup-header">
                    <button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse" title="Close" onclick={handleCloseModal}>
                        <lightning-icon icon-name="utility:close" size="small" alternative-text="close"></lightning-icon>
                    </button>
                    <h2 class="slds-text-heading_medium">{modalTitle}</h2>
                </header>

                <div class="slds-modal__content slds-p-around--medium contact-popup-body">
                    <lightning-record-edit-form
                        object-api-name="Contact"
                        record-id={recordIdToEdit}
                        density="comfy">
                        
                        <div class="slds-grid slds-wrap slds-gutters">
                            <template for:each={dynamicFields} for:item="field">
                                <div key={field.fieldName} class="slds-col slds-size_1-of-1 slds-m-bottom_small">
                                    
                                    <template if:true={field.isRecordType}>
                                        <lightning-combobox
                                            name={field.fieldName}
                                            label={field.label}
                                            value={field.value}
                                            options={recordTypeOptions}
                                            required={field.isRequired}
                                            disabled={field.isDisabled}
                                            class="custom-field-input"
                                            onchange={handleCustomInputChange}>
                                        </lightning-combobox>
                                    </template>

                                    <template if:false={field.isRecordType}>
                                        <lightning-input-field
                                            field-name={field.fieldName}
                                            required={field.isRequired}
                                            disabled={field.isDisabled}
                                            onchange={handleCustomInputChange}>
                                        </lightning-input-field>
                                    </template>

                                </div>
                            </template>
                        </div>

                        <template if:false={isPreviewMode}>
                            <div class="bottom-footer-btn">
                                <button type="button" class="save-btn" onclick={handleSave}>
                                    {saveButtonLabel}
                                </button>
                            </div>
                        </template>

                    </lightning-record-edit-form>
                </div>
            </div>
        </section>
        <div class="slds-backdrop slds-backdrop_open"></div>
    </template> -->

    <template if:true={showCreateModal}>
    <section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open">
        <div class="slds-modal__container contact-popup">
            <header class="slds-modal__header contact-popup-header">
                <button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse" 
                        title="Close" onclick={handleCloseModal}>
                    <lightning-icon icon-name="utility:close" size="small" alternative-text="close"></lightning-icon>
                </button>
                <h2 class="slds-text-heading_medium">{modalTitle}</h2>
            </header>

            <div class="slds-modal__content slds-p-around--medium contact-popup-body">
                <!-- Add onsuccess and onerror handlers here -->
                <lightning-record-edit-form
                    object-api-name="Contact"
                    record-id={recordIdToEdit}
                    onsuccess={handleSuccess}
                    onerror={handleError}
                    record-type-id={recordTypeId} 
                    density="comfy">
                    
                    <div class="slds-grid slds-wrap slds-gutters">
                        <template for:each={dynamicFields} for:item="field">
                            <div key={field.fieldName} class="slds-col slds-size_1-of-1 slds-m-bottom_small">
                                
                                <template if:true={field.isRecordType}>
                                    <!-- Record Type field -->
                                    <lightning-combobox
                                         name="RecordTypeId"
                                        label="Type"
                                        value={recordTypeId} 
                                        options={recordTypeOptions}
                                        required="required"
                                        disabled={field.isDisabled}
                                        class="custom-field-input"
                                        onchange={handleCustomInputChange}>
                                    </lightning-combobox>
                                </template>

                                <template if:false={field.isRecordType}>
                                    <!-- Standard fields handled by lightning-input-field -->
                                    <lightning-input-field
                                        field-name={field.fieldName}
                                        required={field.isRequired}
                                        disabled={field.isDisabled}
                                        onchange={handleCustomInputChange}>
                                    </lightning-input-field>
                                </template>

                            </div>
                        </template>
                    </div>

                    <template if:false={isPreviewMode}>
                        <div class="bottom-footer-btn">
                            <!-- Change onclick to handleSave -->
                            <button type="button" class="save-btn" onclick={handleSave}>
                                {saveButtonLabel}
                            </button>
                        </div>
                    </template>

                </lightning-record-edit-form>
            </div>
        </div>
    </section>
    <div class="slds-backdrop slds-backdrop_open"></div>
</template>

    <c-generic-confirmation-modal
        show-modal={showConfirmationModal}
        title={confirmationModalTitle}
        message={confirmationModalMessage}
        confirm-button-label={deleteConfirmLabel}
        cancel-button-label="Cancel"
        confirm-button-variant="destructive"
        show-three-buttons={isDeleteWithInactiveMode}
        third-button-label="Delete and inactive user"
        onconfirm={handleOnlyDeleteContact}
        onthirdoption={handleDeleteWithInactiveUser}
        oncancel={handleConfirmationModalCancel}>
    </c-generic-confirmation-modal>

    <template if:true={showConfigModal}>
        <c-contact-config-body onconfigurationupdated={handleConfigUpdated}></c-contact-config-body>
    </template>
</template>