<template>
    <template if:true={isLoading}>
        <lightning-spinner alternative-text="Loading" size="medium"></lightning-spinner>
    </template>

    <div class="main-card">
        <!-- Header Section -->
        <div class="filter-search-container">
            <div class="search-bar">
                <lightning-input
                    type="search"
                    variant="label-hidden"
                    placeholder="Search  Location Processes..."
                    value={searchTerm}
                    onchange={handleSearch}
                    class="search-bar-input">
                </lightning-input>
            </div>


            <div class="right-contols">
                <!-- Show Save/Discard Actions only for users with edit permission -->
                <template if:true={canEdit}>
                    <div class="action-buttons">
                        <button 
                            class="action-button"
                            onclick={handleDiscardChanges}
                            disabled={isButtonsDisabled}
                            title={discardButtonTitle}>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M3 6h18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6m3 0V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M10 11v6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M14 11v6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            Discard Changes
                        </button>
                        <button 
                            class="action-button save-button"
                            onclick={handleSaveChanges}
                            disabled={isSaveDisabled}>
                            <template if:true={isSaving}>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                                    <path d="M12 6v6l4 2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </template>
                            <template if:false={isSaving}>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <polyline points="17,21 17,13 7,13 7,21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <polyline points="7,3 7,8 15,8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </template>
                            Save Changes
                        </button>
                    </div>
                </template>

                <div class="sort-description-container">
                    <template if:true={sortDescription}>
                        <div class="sort-description">
                            <div>
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M10 14H2M8 10H2M6 6H2M12 18H2M19 20V4M19 20L22 17M19 20L16 17M19 4L22 7M19 4L16 7" 
                                        stroke="#5e5adb" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" 
                                        fill="none"/>
                                </svg>
                            </div>
                            <div class="sort-text">{sortDescription}</div>
                        </div>
                    </template>
                </div>

            </div>

        </div>

        <!-- Remove Modifications Summary Section -->

        <!-- Data Table Container -->
        <div class="data-table-container">
            <template if:true={isDataAvailable}>
                <table class="custom-data-table">
                    <thead class="table-header">
                        <tr>
                            <template for:each={activeProcessTableColumns} for:item="column">
                                <template if:true={column.sortable}>
                                    <th key={column.fieldName} 
                                        class="header-cell center-trancate-head sortable-header" 
                                        data-id={column.fieldName}
                                        data-sort-field={column.fieldName}
                                        onclick={handleSortClick}>
                                        <div class="sort-header-content">
                                            <span class="column-label">{column.label}</span>
                                            <div class="sort-icon">
                                                <svg width="16" height="16" viewBox="0 0 384 512" xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M374.6 246.6C368.4 252.9 360.2 256 352 256s-16.38-3.125-22.62-9.375L224 141.3V448c0 17.69-14.33 31.1-31.1 31.1S160 465.7 160 448V141.3L54.63 246.6c-12.5 12.5-32.75 12.5-45.25 0s-12.5-32.75 0-45.25l160-160c12.5-12.5 32.75-12.5 45.25 0l160 160C387.1 213.9 387.1 234.1 374.6 246.6z" />
                                                </svg>
                                            </div>
                                        </div>
                                    </th>
                                </template>
                                <template if:false={column.sortable}>
                                    <th key={column.fieldName} 
                                        class="header-cell center-trancate-head non-sortable-header">
                                        <div class="header-content">
                                            <span class="column-label">{column.label}</span>
                                        </div>
                                    </th>
                                </template>
                            </template>
                        </tr>
                    </thead>
                    <tbody class="table-body">
                        <template for:each={displayedProcesses} for:item="process">
                            <tr key={process.Id}>
                                <template for:each={process.displayFields} for:item="field">
                                    <td key={field.key}>
                                        <template if:true={field.isCurrency}>
                                            <template if:true={field.hasValue}>
                                                <lightning-formatted-number 
                                                    value={field.currencyValue} 
                                                    format-style="currency" 
                                                    currency-code="USD">
                                                </lightning-formatted-number>
                                            </template>
                                            <template if:false={field.hasValue}>--</template>
                                        </template>
                                        <template if:false={field.isCurrency}>
                                            <template if:true={field.isSlider}>
                                                <div class="slider-container" style={field.isModified} data-slider-modified={field.isModified}>
                                                    <input type="range" 
                                                           min="0" 
                                                           max="100" 
                                                           step="1"
                                                           value={field.displayValue}
                                                           data-process-id={process.Id}
                                                           data-original-value={field.originalValue}
                                                           onchange={handleSliderChange}
                                                           oninput={handleSliderInput}
                                                           style={field.progressStyle}
                                                           class="completion-slider"
                                                           disabled={isReadOnlyMode}>
                                                    <div class="slider-value">{field.displayValue}%</div>
                                                </div>
                                            </template>
                                            <template if:false={field.isSlider}>
                                                <template if:true={field.isPercent}>
                                                    <template if:true={field.hasValue}>
                                                        <lightning-formatted-number 
                                                            value={field.percentValue} 
                                                            format-style="percent-fixed"
                                                            maximum-fraction-digits="2">
                                                        </lightning-formatted-number>
                                                    </template>
                                                    <template if:false={field.hasValue}>0%</template>
                                                </template>
                                                <template if:false={field.isPercent}>
                                                    <template if:true={field.isNameField}>
                                                        <!-- <a href={process.recordUrl} target="_blank" class="name-link">
                                                            {field.value}
                                                        </a> -->
                                                        <span class="process-name-text">{field.value}</span>
                                                    </template>
                                                    <template if:false={field.isNameField}>
                                                        <template if:true={field.isLocationField}>
                                                            <!-- <a href={process.locationUrl} target="_blank" class="name-link">
                                                                {field.value}
                                                            </a> -->
                                                            <span class="location-name-text">{field.value}</span>
                                                        </template>
                                                        <template if:false={field.isLocationField}>
                                                            <template if:true={field.hasValue}>
                                                                <span class="text-truncate">{field.value}</span>
                                                            </template>
                                                            <template if:false={field.hasValue}>
                                                                --
                                                            </template>
                                                        </template>
                                                    </template>
                                                </template>
                                            </template>
                                        </template>
                                    </td>
                                </template>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </template>

            <template if:false={isDataAvailable}>
                <div class="no-prop">
                    <div class="empty-state">
                        <div class="empty-state__content">
                            <div class="empty-state__icon">
                                <img src="/resource/wfrecon__emptyState" alt="" draggable="false">
                            </div>
                            <div class="empty-state__message">No location processes found for this job</div>
                            <div class="empty-state__subtitle">Location processes will appear here when available</div>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </div>
</template>